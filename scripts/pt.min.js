var CanvasSpace,Circle,Color,Curve,DOMSpace,Delaunay,Easing,Form,Grid,GridCascade,Line,Matrix,Noise,Pair,Particle,ParticleEmitter,ParticleField,ParticleSystem,Point,PointSet,QuadTree,Rectangle,SVGForm,SVGSpace,SamplePoints,Space,StripeBound,Timer,Triangle,UI,Util,Vector,bind=function(t,i){return function(){return t.apply(i,arguments)}},extend=function(t,i){function e(){this.constructor=t}for(var n in i)hasProp.call(i,n)&&(t[n]=i[n]);return e.prototype=i.prototype,t.prototype=new e,t.__super__=i.prototype,t},hasProp={}.hasOwnProperty,slice=[].slice,Const=function(){function t(){}return t.xy="xy",t.yz="yz",t.xz="xz",t.xyz="xyz",t.identical=-1,t.right=3,t.bottom_right=4,t.bottom=5,t.bottom_left=6,t.left=7,t.top_left=0,t.top=1,t.top_right=2,t.sideLabels=["identical","right","bottom right","bottom","bottom left","left","top left","top","top right"],t.epsilon=1e-4,t.pi=Math.PI,t.two_pi=6.283185307179586,t.half_pi=1.5707963267948966,t.quarter_pi=.7853981633974483,t.one_degree=.017453292519943295,t.rad_to_deg=57.29577951308232,t.deg_to_rad=.017453292519943295,t.gravity=9.81,t.newton=.10197,t.gaussian=.3989422804014327,t}();this.Const=Const,Matrix=function(){function t(){}return t.rotateAnchor2D=function(t,i,e){var n,s,o;return null==e&&(e=Const.xy),n=i.get2D(e),[s=Math.cos(t),o=Math.sin(t),0,-o,s,0,n.x*(1-s)+n.y*o,n.y*(1-s)-n.x*o,1]},t.reflectAnchor2D=function(t,i){var e,n,s,o;return null==i&&(i=Const.xy),s=t.intercept(i),e=2*Math.atan(s.slope),[n=Math.cos(e),o=Math.sin(e),0,o,-n,0,-s.yi*o,s.yi+s.yi*n,1]},t.shearAnchor2D=function(t,i,e,n){var s,o,r;return null==n&&(n=Const.xy),s=e.get2D(n),[1,o=Math.tan(t),0,r=Math.tan(i),1,0,-s.y*r,-s.x*o,1]},t.scaleAnchor2D=function(t,i,e,n){var s;return null==n&&(n=Const.xy),[t,0,0,0,i,0,-(s=e.get2D(n)).x*t+s.x,-s.y*i+s.y,1]},t.scale2D=function(t,i){return[t,0,0,0,i,0,0,0,1]},t.shear2D=function(t,i){return[1,Math.tan(t),0,Math.tan(i),1,0,0,0,1]},t.rotate2D=function(t,i){return[t,i,0,-i,t,0,0,0,1]},t.translate2D=function(t,i){return[1,0,0,0,1,0,t,i,1]},t.transform2D=function(t,i,e,n){var s,o,r;return null==e&&(e=Const.xy),null==n&&(n=!1),o=(s=t.get2D(e)).x*i[0]+s.y*i[3]+i[6],r=s.x*i[1]+s.y*i[4]+i[7],s.x=o,s.y=r,s=s.get2D(e,!0),n?s:(t.set(s),t)},t}(),this.Matrix=Matrix,Util=function(){function e(){}return e.toRadian=function(t){return t*Const.deg_to_rad},e.toDegree=function(t){return t*Const.rad_to_deg},e.toHexColor=function(t){var i=Math.floor(t).toString(16);return 1===i.length?"0"+i:i},e.toRGBColor=function(t,i,e){var n,s,o;return null==i&&(i=!1),null==e&&(e=1),"#"===t[0]&&(t=t.substr(1)),n=3===t.length?(o=parseInt(t[0]+t[0],16),s=parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16)):6<=t.length?(o=parseInt(t[0]+t[1],16),s=parseInt(t[2]+t[3],16),parseInt(t[4]+t[5],16)):s=o=0,i?"rgba("+o+","+s+","+n+","+e+")":[o,s,n,e]},e.bound=function(t,i,e){var n,s;return null==e&&(e=!1),(s=i/2)<(n=t%i)?n-=i:n<-s&&(n+=i),e&&n<0?n+i:n},e.boundAngle=function(t,i){return e.bound(t,360,i)},e.boundRadian=function(t,i){return e.bound(t,Const.two_pi,i)},e.boundingBox=function(t,i){var e,n,s,o,r;for(null==i&&(i=!1),o=new Point(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),s=new Point(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),e=0,n=t.length;e<n;e++)(r=t[e]).x<o.x&&(o.x=r.x),r.y<o.y&&(o.y=r.y),r.x>s.x&&(s.x=r.x),r.y>s.y&&(s.y=r.y),i&&(r.z<o.z&&(o.z=r.z),r.z>s.z&&(s.z=r.z));return new Rectangle(o).to(s)},e.lerp=function(t,i,e){return(1-e)*t+e*i},e.centroid=function(t){for(var i,e=new Vector,n=0,s=t.length;n<s;n++)i=t[n],e.add(i);return e.divide(t.length)},e.same=function(t,i,e){return null==e&&(e=Const.epsilon),Math.abs(t-i)<e},e.within=function(t,i,e){return t>=Math.min(i,e)&&t<=Math.max(i,e)},e.randomRange=function(t,i){var e;return null==i&&(i=0),e=i<t?t-i:i-t,t+Math.random()*e},e.mixin=function(t,i){var e;for(e in i)i[e],i.hasOwnProperty(e)&&(t.prototype[e]=i[e]);return t},e.extend=function(t,i){return t.prototype=Object.create(i.prototype),t.prototype.constructor=t},e.clonePoints=function(t){for(var i,e=[],n=0,s=t.length;n<s;n++)i=t[n],e.push(i.clone());return e},e.contextRotateOrigin=function(t,i,e,n,s){var o;return null==n&&(n=!1),o=i.size(),n||(n=o.$multiply(.5)).add(i),s&&(s.size(),Form.rect(t,s),t.clip()),t.translate(n.x,n.y),t.rotate(e),t.translate(-n.x,-n.y)},e.sinCosTable=function(){for(var t,i=[],e=[],n=t=0;t<=360;n=t+=1)i[n]=Math.cos(n*Math.PI/180),e[n]=Math.sin(n*Math.PI/180);return{sin:e,cos:i}},e.chance=function(t){return Math.random()<t},e.gaussian=function(t,i,e){return null==i&&(i=0),null==e&&(e=1),t=(t-i)/e,Const.gaussian*Math.exp(-.5*t*t)/e},e}(),this.Util=Util,Timer=function(){function t(t){null==t&&(t=1e3),this.duration=t,this._time=0,this._ease=function(t,i,e,n){return t/n},this._intervalID=-1}return t.prototype.start=function(t){var i=Math.min(Date.now()-this._time,this.duration);return t||i>=this.duration?this._time=Date.now():void 0},t.prototype.setEasing=function(t){return this._ease=t},t.prototype.check=function(){var t=Math.min(Date.now()-this._time,this.duration);return this._ease(t,0,1,this.duration)},t.prototype.track=function(i){var e;return clearInterval(this._intervalID),this.start(!0),(e=this)._intervalID=setInterval(function(){var t=e.check();return i(t),1<=t?clearInterval(e._intervalID):void 0},25),this._intervalID},t}(),this.Timer=Timer,Space=function(){function t(t){null==t&&(t="space"),this.id=t,this.size=new Vector,this.center=new Vector,this._timePrev=0,this._timeDiff=0,this._timeEnd=-1,this.items={},this._animID=-1,this._animCount=0,this._animPause=!1,this._refresh=!0}return t.prototype.refresh=function(t){return this._refresh=t,this},t.prototype.render=function(t){return this},t.prototype.resize=function(t,i){},t.prototype.clear=function(){},t.prototype.add=function(t){var i;if(null==t.animate||"function"!=typeof t.animate)throw"a player object for Space.add must define animate()";return i=this._animCount++,(this.items[i]=t).animateID=i,null!=t.onSpaceResize&&t.onSpaceResize(this.size.x,this.size.y),this},t.prototype.remove=function(t){return delete this.items[t.animateID],this},t.prototype.removeAll=function(){return this.items={},this},t.prototype.play=function(t){var i,e;if(null==t&&(t=0),this._animID=requestAnimationFrame((e=this,function(t){return e.play(t)})),!this._animPause){this._timeDiff=t-this._timePrev;try{this._playItems(t)}catch(t){throw i=t,cancelAnimationFrame(this._animID),console.error(i.stack),i}return this._timePrev=t,this}},t.prototype._playItems=function(t){var i,e;for(i in this._refresh&&this.clear(),e=this.items)e[i].animate(t,this._timeDiff,this.ctx);return 0<=this._timeEnd&&t>this._timeEnd&&cancelAnimationFrame(this._animID),this},t.prototype.pause=function(t){return null==t&&(t=!1),this._animPause=!t||!this._animPause,this},t.prototype.resume=function(){return this._animPause=!1,this},t.prototype.stop=function(t){return null==t&&(t=0),this._timeEnd=t,this},t.prototype.playTime=function(t){return null==t&&(t=5e3),this.play(),this.stop(t)},t.prototype.bindCanvas=function(t,i){return this.space.addEventListener?this.space.addEventListener(t,i):void 0},t.prototype.bindMouse=function(t){return null==t&&(t=!0),this.space.addEventListener&&this.space.removeEventListener?t?(this.space.addEventListener("mousedown",this._mouseDown.bind(this)),this.space.addEventListener("mouseup",this._mouseUp.bind(this)),this.space.addEventListener("mouseover",this._mouseOver.bind(this)),this.space.addEventListener("mouseout",this._mouseOut.bind(this)),this.space.addEventListener("mousemove",this._mouseMove.bind(this))):(this.space.removeEventListener("mousedown",this._mouseDown.bind(this)),this.space.removeEventListener("mouseup",this._mouseUp.bind(this)),this.space.removeEventListener("mouseover",this._mouseOver.bind(this)),this.space.removeEventListener("mouseout",this._mouseOut.bind(this)),this.space.removeEventListener("mousemove",this._mouseMove.bind(this))):void 0},t.prototype.bindTouch=function(t){return null==t&&(t=!0),this.space.addEventListener&&this.space.removeEventListener?t?(this.space.addEventListener("touchstart",this._mouseDown.bind(this)),this.space.addEventListener("touchend",this._mouseUp.bind(this)),this.space.addEventListener("touchmove",(i=this,function(t){return t.preventDefault(),i._mouseMove(t)})),this.space.addEventListener("touchcancel",this._mouseOut.bind(this))):(this.space.removeEventListener("touchstart",this._mouseDown.bind(this)),this.space.removeEventListener("touchend",this._mouseUp.bind(this)),this.space.removeEventListener("touchmove",this._mouseMove.bind(this)),this.space.removeEventListener("touchcancel",this._mouseOut.bind(this))):void 0;var i},t.prototype.touchesToPoints=function(s,o){var r;return null==o&&(o="touches"),s&&s[o]?function(){for(var t=s[o],i=[],e=0,n=t.length;e<n;e++)r=t[e],i.push(new Vector(r.pageX-this.boundRect.left,r.pageY-this.boundRect.top));return i}.call(this):[]},t.prototype._mouseAction=function(t,i){var e,n,s,o,r,h,u,c,a;if(i.touches||i.changedTouches){for(n in u=[],r=this.items)null!=(a=r[n]).onTouchAction?(s=(e=i.changedTouches&&0<i.changedTouches.length)?i.changedTouches.item(0).pageX:0,o=e?i.changedTouches.item(0).pageY:0,u.push(a.onTouchAction(t,s,o,i))):u.push(void 0);return u}for(n in c=[],h=this.items)null!=(a=h[n]).onMouseAction?(s=i.offsetX||i.layerX,o=i.offsetY||i.layerY,c.push(a.onMouseAction(t,s,o,i))):c.push(void 0);return c},t.prototype._mouseDown=function(t){return this._mouseAction("down",t),this._mdown=!0},t.prototype._mouseUp=function(t){return this._mouseAction("up",t),this._mdrag&&this._mouseAction("drop",t),this._mdown=!1,this._mdrag=!1},t.prototype._mouseMove=function(t){return this._mouseAction("move",t),this._mdown?(this._mdrag=!0,this._mouseAction("drag",t)):void 0},t.prototype._mouseOver=function(t){return this._mouseAction("over",t)},t.prototype._mouseOut=function(t){return this._mouseAction("out",t),this._mdrag&&this._mouseAction("drop",t),this._mdrag=!1},t}(),this.Space=Space,CanvasSpace=function(){function n(t,i,e){null==t&&(t="pt_space"),null==i&&(i=!1),null==e&&(e="2d"),this._resizeHandler=bind(this._resizeHandler,this),n.__super__.constructor.apply(this,arguments),this.space=document.querySelector("#"+this.id),this.bound=null,this.boundRect={top:0,left:0,width:0,height:0},this.pixelScale=1,this.appended=!0,this.space||(this.space=document.createElement("canvas"),this.space.setAttribute("id",this.id),this.appended=!1),this._mdown=!1,this._mdrag=!1,this.bgcolor=i,this.ctx=this.space.getContext(e)}return extend(n,Space),n.prototype.display=function(t,i,e){var n,s;if(null==t&&(t="#pt"),null==e&&(e=!0),!this.appended){if(this.bound=document.querySelector(t),this.boundRect=this.bound.getBoundingClientRect(),this.pixelScale=1,e&&(n=window.devicePixelRatio||1,s=this.ctx.webkitBackingStorePixelRatio||this.ctx.mozBackingStorePixelRatio||this.ctx.msBackingStorePixelRatio||this.ctx.oBackingStorePixelRatio||this.ctx.backingStorePixelRatio||1,this.pixelScale=n/s),!this.bound)throw"Cannot add canvas to element "+t;this.resize(this.boundRect.width,this.boundRect.height),this.autoResize(!0),this.space.parentNode!==this.bound&&this.bound.appendChild(this.space),this.appended=!0,setTimeout(function(){return this.space.dispatchEvent(new Event("ready")),i?i(this.boundRect.width,this.boundRect.height,this.space):void 0}.bind(this))}return this},n.prototype._resizeHandler=function(t){return this.boundRect=this.bound.getBoundingClientRect(),this.resize(this.boundRect.width,this.boundRect.height,t)},n.prototype.autoResize=function(t){return null==t&&(t=!0),t?window.addEventListener("resize",this._resizeHandler):window.removeEventListener("resize",this._resizeHandler),this},n.prototype.resize=function(t,i,e){var n,s,o;for(n in t=Math.floor(t),i=Math.floor(i),this.size.set(t,i),this.center=new Vector(t/2,i/2),this.boundRect.width=t,this.boundRect.height=i,this.space.width=t*this.pixelScale,this.space.height=i*this.pixelScale,this.space.style.width=t+"px",this.space.style.height=i+"px",1!==this.pixelScale&&this.ctx.scale(this.pixelScale,this.pixelScale),o=this.items)null!=(s=o[n]).onSpaceResize&&s.onSpaceResize(t,i,e);return this.render(this.ctx),this},n.prototype.clear=function(t){var i;return t&&(this.bgcolor=t),i=this.ctx.fillStyle,this.bgcolor?(this.ctx.fillStyle=this.bgcolor,this.ctx.fillRect(0,0,this.size.x,this.size.y)):this.ctx.clearRect(0,0,this.size.x,this.size.y),this.ctx.fillStyle=i,this},n.prototype.animate=function(t){var i,e;for(i in this.ctx.save(),this._refresh&&this.clear(),e=this.items)e[i].animate(t,this._timeDiff,this.ctx);return 0<=this._timeEnd&&t>this._timeEnd&&cancelAnimationFrame(this._animID),this.ctx.restore(),this},n}(),this.CanvasSpace=CanvasSpace,DOMSpace=function(){function n(t,i,e){null==t&&(t="pt_space"),null==i&&(i=!1),null==e&&(e="html"),this._resizeHandler=bind(this._resizeHandler,this),n.__super__.constructor.apply(this,arguments),this.space=document.querySelector("#"+this.id),this.css={width:"100%",height:"100%"},this.bound=null,this.boundRect={top:0,left:0,width:0,height:0},this.appended=!0,this.space||this._createSpaceElement(),this._mdown=!1,this._mdrag=!1,this.bgcolor=i,this.ctx={}}return extend(n,Space),n.prototype._createSpaceElement=function(){return this.space=document.createElement("div"),this.space.setAttribute("id",this.id),this.appended=!1},n.prototype.setCSS=function(t,i,e){return null==e&&(e=!1),this.css[t]=e?i+"px":i,this},n.prototype.updateCSS=function(){var t,i,e=this.css,n=[];for(t in e)i=e[t],n.push(this.space.style[t]=i);return n},n.prototype.display=function(t,i){if(null==t&&(t="#pt"),!this.appended){if(this.bound=document.querySelector(t),this.boundRect=this.bound.getBoundingClientRect(),!this.bound)throw"Cannot add canvas to element "+t;this.resize(this.boundRect.width,this.boundRect.height),this.autoResize(!0),this.space.parentNode!==this.bound&&this.bound.appendChild(this.space),this.appended=!0,setTimeout(function(){return this.space.dispatchEvent(new Event("ready")),i?i(this.boundRect.width,this.boundRect.height,this.space):void 0}.bind(this))}return this},n.prototype._resizeHandler=function(t){return this.boundRect=this.bound.getBoundingClientRect(),this.resize(this.boundRect.width,this.boundRect.height,t)},n.prototype.autoResize=function(t){return null==t&&(t=!0),t?window.addEventListener("resize",this._resizeHandler):window.removeEventListener("resize",this._resizeHandler),this},n.prototype.resize=function(t,i,e){var n,s,o;for(n in this.size.set(t,i),this.center=new Vector(t/2,i/2),o=this.items)null!=(s=o[n]).onSpaceResize&&s.onSpaceResize(t,i,e);return this},n.prototype.clear=function(){return this.space.innerHML=""},n.prototype.animate=function(t){var i,e=this.items;for(i in e)e[i].animate(t,this._timeDiff,this.ctx);return 0<=this._timeEnd&&t>this._timeEnd&&cancelAnimationFrame(this._animID),this},n.attr=function(t,i){var e,n,s=[];for(e in i)n=i[e],s.push(t.setAttribute(e,n));return s},n.css=function(t){var i,e,n="";for(i in t)(e=t[i])&&(n+=i+": "+e+"; ");return n},n}(),this.DOMSpace=DOMSpace,Form=function(){function p(t){this.space=t,this.cc=t.ctx,this.cc.fillStyle="#999",this.cc.strokeStyle="#666",this.cc.lineWidth=1,this.cc.font="11px sans-serif",this.filled=!0,this.stroked=!0,this.fontSize=11,this.fontFace="sans-serif"}return p.context=function(t){var i=document.getElementById(t),e=!(!i||!i.getContext)&&i.getContext("2d");if(!e)throw"Cannot initiate canvas 2d context";return e},p.line=function(t,i){if(!i.p1)throw i.toString()+" is not a Pair";return t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(i.p1.x,i.p1.y),t.stroke()},p.lines=function(t,i){for(var e,n=[],s=0,o=i.length;s<o;s++)e=i[s],n.push(p.line(t,e));return n},p.rect=function(t,i,e,n){if(null==e&&(e=!0),null==n&&(n=!1),!i.p1)throw""+(i.toString()===!a(Pair));return t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(i.x,i.p1.y),t.lineTo(i.p1.x,i.p1.y),t.lineTo(i.p1.x,i.y),t.closePath(),n&&t.stroke(),e?t.fill():void 0},p.circle=function(t,i,e,n){null==e&&(e=!0),null==n&&(n=!1),t.beginPath(),t.arc(i.x,i.y,i.radius,0,Const.two_pi,!1),e&&t.fill(),n&&t.stroke()},p.arc=function(t,i,e,n,s){return t.beginPath(),t.arc(i.x,i.y,e,n,s),t.stroke()},p.triangle=function(t,i,e,n){null==e&&(e=!0),null==n&&(n=!1),t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(i.p1.x,i.p1.y),t.lineTo(i.p2.x,i.p2.y),t.closePath(),e&&t.fill(),n&&t.stroke()},p.point=function(t,i,e,n,s,o){var r,h,u,c;return null==e&&(e=2),null==n&&(n=!0),null==s&&(s=!1),null==o&&(o=!1),o?(t.beginPath(),t.arc(i.x,i.y,e,0,Const.two_pi,!1)):(r=i.x-e,u=i.y-e,h=i.x+e,c=i.y+e,t.beginPath(),t.moveTo(r,u),t.lineTo(r,c),t.lineTo(h,c),t.lineTo(h,u),t.closePath()),n&&t.fill(),s&&t.stroke(),i},p.points=function(t,i,e,n,s,o){var r,h,u,c;for(null==e&&(e=2),null==n&&(n=!0),null==s&&(s=!1),null==o&&(o=!1),c=[],r=0,h=i.length;r<h;r++)u=i[r],c.push(p.point(t,u,e,n,s,o));return c},p.polygon=function(t,i,e,n,s){var o,r,h;if(null==e&&(e=!0),null==n&&(n=!0),null==s&&(s=!0),!(i.length<=1)){for(t.beginPath(),t.moveTo(i[0].x,i[0].y),r=o=1,h=i.length;o<h;r=o+=1)t.lineTo(i[r].x,i[r].y);e&&t.closePath(),n&&t.fill(),s&&t.stroke()}},p.curve=function(t,i){return p.polygon(t,i,!1,!1,!0)},p.text=function(t,i,e,n){return t.fillText(e,i.x,i.y,n)},p.prototype.fill=function(t){return this.cc.fillStyle=t||"transparent",this.filled=!!t,this},p.prototype.stroke=function(t,i,e){return this.cc.strokeStyle=t||"transparent",this.stroked=!!t,i&&(this.cc.lineWidth=i),e&&(this.cc.lineJoin=e),this},p.prototype.font=function(t,i){return null==i&&(i=this.fontFace),this.fontSize=t,this.cc.font=t+"px "+i,this},p.prototype.draw=function(t){return this.sketch(t)},p.prototype.sketch=function(t){return t.floor(),t instanceof Circle?p.circle(this.cc,t,this.filled,this.stroked):t instanceof Rectangle?p.rect(this.cc,t,this.filled,this.stroked):t instanceof Triangle?p.triangle(this.cc,t,this.filled,this.stroked):t instanceof Line||t instanceof Pair?p.line(this.cc,t):t instanceof PointSet?p.polygon(this.cc,t.points):(t instanceof Vector||t instanceof Point)&&p.point(this.cc,t),this},p.prototype.point=function(t,i,e){return null==i&&(i=2),null==e&&(e=!1),p.point(this.cc,t,i,this.filled,this.stroked,e),this},p.prototype.points=function(t,i,e){return null==i&&(i=2),null==e&&(e=!1),p.points(this.cc,t,i,this.filled,this.stroked,e),this},p.prototype.line=function(t){return p.line(this.cc,t),this},p.prototype.lines=function(t){return p.lines(this.cc,t),this},p.prototype.rect=function(t){return p.rect(this.cc,t,this.filled,this.stroked),this},p.prototype.circle=function(t){return p.circle(this.cc,t,this.filled,this.stroked),this},p.prototype.arc=function(t,i,e){return p.arc(this.cc,t,t.radius,i,e),this},p.prototype.triangle=function(t){return p.triangle(this.cc,t,this.filled,this.stroked),this},p.prototype.polygon=function(t,i){return p.polygon(this.cc,t,i,this.filled,this.stroked),this},p.prototype.curve=function(t){return p.curve(this.cc,t),this},p.prototype.text=function(t,i,e,n,s){var o;return null==e&&(e=1e3),o=new Vector(t),n&&o.add(n,0),s&&o.add(0,s),this.cc.fillText(i,o.x,o.y,e),this},p}(),this.Form=Form,Point=function(){function n(t){this.copy(n.get(arguments))}return n.get=function(t){return 0<t.length?"object"==typeof t[0]?t[0]instanceof Array||0<t[0].length?{x:t[0][0]||0,y:t[0][1]||0,z:t[0][2]||0}:{x:t[0].x||0,y:t[0].y||0,z:t[0].z||0}:{x:t[0]||0,y:t[1]||0,z:t[2]||0}:{x:0,y:0,z:0}},n.prototype.quadrant=function(t,i){return null==i&&(i=Const.epsilon),t.near(this)?Const.identical:Math.abs(t.x-this.x)<i?t.y<this.y?Const.top:Const.bottom:Math.abs(t.y-this.y)<i?t.x<this.x?Const.left:Const.right:t.y<this.y&&t.x>this.x?Const.top_right:t.y<this.y&&t.x<this.x?Const.top_left:t.y>this.y&&t.x<this.x?Const.bottom_left:Const.bottom_right},n.prototype.set=function(t){var i=n.get(arguments);return this.x=i.x,this.y=i.y,this.z=i.z,this},n.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},n.prototype.clone=function(){return new n(this)},n.prototype.toString=function(){return"Point "+this.x+", "+this.y+", "+this.z},n.prototype.toArray=function(){return[this]},n.prototype.get2D=function(t,i){return null==i&&(i=!1),t===Const.xy?new this.__proto__.constructor(this):t===Const.xz?new this.__proto__.constructor(this.x,this.z,this.y):t===Const.yz?i?new this.__proto__.constructor(this.z,this.x,this.y):new this.__proto__.constructor(this.y,this.z,this.x):new this.__proto__.constructor(this)},n.prototype.min=function(t){var i=n.get(arguments);return this.x=Math.min(this.x,i.x),this.y=Math.min(this.y,i.y),this.z=Math.min(this.z,i.z),this},n.prototype.$min=function(t){var i=n.get(arguments);return new this.__proto__.constructor(Math.min(this.x,i.x),Math.min(this.y,i.y),Math.min(this.z,i.z))},n.prototype.max=function(t){var i=n.get(arguments);return this.x=Math.max(this.x,i.x),this.y=Math.max(this.y,i.y),this.z=Math.max(this.z,i.z),this},n.prototype.$max=function(t){var i=n.get(arguments);return new this.__proto__.constructor(Math.max(this.x,i.x),Math.max(this.y,i.y),Math.max(this.z,i.z))},n.prototype.equal=function(t){var i=n.get(arguments);return i.x===this.x&&i.y===this.y&&i.z===this.z},n.prototype.near=function(t,i){var e;return null==i&&(i=Const.epsilon),e=n.get(arguments),Math.abs(e.x-this.x)<i&&Math.abs(e.y-this.y)<i&&Math.abs(e.z-this.z)<i},n.prototype.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},n.prototype.ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},n}(),this.Point=Point,Vector=function(){function r(){r.__super__.constructor.apply(this,arguments)}return extend(r,Point),r.prototype._getArgs=function(t){return"number"==typeof t[0]&&1<t.length?t:t[0]},r.prototype.add=function(t){var i;return"number"==typeof t&&1===arguments.length?(this.x+=t,this.y+=t,this.z+=t):(i=Point.get(arguments),this.x+=i.x,this.y+=i.y,this.z+=i.z),this},r.prototype.$add=function(t){var i=this._getArgs(arguments);return new r(this).add(i)},r.prototype.subtract=function(t){var i;return"number"==typeof t&&1===arguments.length?(this.x-=t,this.y-=t,this.z-=t):(i=Point.get(arguments),this.x-=i.x,this.y-=i.y,this.z-=i.z),this},r.prototype.$subtract=function(t){var i=this._getArgs(arguments);return new r(this).subtract(i)},r.prototype.multiply=function(t){var i;return 1===arguments.length&&("number"==typeof t||"object"==typeof t&&1===t.length)?(this.x*=t,this.y*=t,this.z*=t):(i=Point.get(arguments),this.x*=i.x,this.y*=i.y,this.z*=i.z),this},r.prototype.$multiply=function(t){var i=this._getArgs(arguments);return new r(this).multiply(i)},r.prototype.divide=function(t){var i;return 1===arguments.length&&("number"==typeof t||"object"==typeof t&&1===t.length)?(this.x/=t,this.y/=t,this.z/=t):(i=Point.get(arguments),this.x/=i.x,this.y/=i.y,this.z/=i.z),this},r.prototype.$divide=function(t){var i=this._getArgs(arguments);return new r(this).divide(i)},r.prototype.op=function(){for(var t,i=arguments[0],e=2<=arguments.length?slice.call(arguments,1):[],n=this.toArray(),s=0,o=n.length;s<o;s++)(t=n[s])[i].apply(t,e);return this},r.prototype.$op=function(){for(var t,i=arguments[0],e=2<=arguments.length?slice.call(arguments,1):[],n=this.clone(),s=n.toArray(),o=0,r=s.length;o<r;o++)(t=s[o])[i].apply(t,e);return n},r.prototype.angle=function(t){var i,e;return 0===arguments.length?Math.atan2(this.y,this.x):("string"==typeof t?(i=t,e=1<arguments.length?this.$subtract(arguments[1]).multiply(-1):void 0):(e=this.$subtract(t).multiply(-1),i=!1),e&&!i?Math.atan2(e.y,e.x):i===Const.xy?e?Math.atan2(e.y,e.x):Math.atan2(this.y,this.x):i===Const.yz?e?Math.atan2(e.z,e.y):Math.atan2(this.z,this.y):i===Const.xz?e?Math.atan2(e.z,e.x):Math.atan2(this.z,this.x):void 0)},r.prototype.angleBetween=function(t,i){return null==i&&(i=Const.xy),Util.boundRadian(this.angle(i),!0)-Util.boundRadian(t.angle(i),!0)},r.prototype.magnitude=function(t){var i,e,n,s={x:this.x*this.x,y:this.y*this.y,z:this.z*this.z},o=1<=arguments.length&&!arguments[arguments.length-1]?function(t){return t}:Math.sqrt;return 0===arguments.length?o(s.x+s.y+s.z):("string"==typeof t?(i=t,n=1<arguments.length&&arguments[1]?this.$subtract(arguments[1]):void 0):(n=this.$subtract(t),i=!1),e=n?{x:n.x*n.x,y:n.y*n.y,z:n.z*n.z}:s,n&&!i?o(e.x+e.y+e.z):i===Const.xy?o(e.x+e.y):i===Const.yz?o(e.y+e.z):i===Const.xz?o(e.x+e.z):void 0)},r.prototype.distance=function(t,i){return null==i&&(i=Const.xy),this.magnitude(i,t)},r.prototype.normalize=function(){return this.set(this.$normalize()),this},r.prototype.$normalize=function(){var t=this.magnitude();return 0===t?new r:new r(this.x/t,this.y/t,this.z/t)},r.prototype.abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this.z=Math.abs(this.z),this},r.prototype.dot=function(t,i){return null==i&&(i=Const.xyz),i===Const.xyz?this.x*t.x+this.y*t.y+this.z*t.z:i===Const.xy?this.x*t.x+this.y*t.y:i===Const.yz?this.y*t.y+this.z*t.z:i===Const.xz?this.x*t.x+this.z*t.z:this.x*t.x+this.y*t.y+this.z*t.z},r.prototype.projection=function(t,i){var e,n,s,o;return null==i&&(i=Const.xyz),o=t.magnitude(),e=this.$normalize(),n=new r(t.x/o,t.y/o,t.z/o),s=e.dot(n,i),e.$multiply(o*s)},r.prototype.cross=function(t){return new r(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},r.prototype.bisect=function(t,i){return null==i&&(i=!1),i?this.$add(t).divide(2):this.$normalize().add(t.$normalize()).divide(2)},r.prototype.perpendicular=function(t){switch(null==t&&(t=Const.xy),t){case Const.xy:return[new r(-this.y,this.x,this.z),new r(this.y,-this.x,this.z)];case Const.yz:return[new r(this.x,-this.z,this.y),new r(this.x,this.z,-this.y)];case Const.xz:return[new r(-this.z,this.y,this.x),new r(this.z,-this.y,this.x)];default:return[new r(-this.y,this.x,this.z),new r(this.y,-this.x,this.z)]}},r.prototype.isPerpendicular=function(t,i){return null==i&&(i=Const.xyz),0===this.dot(t,i)},r.prototype.surfaceNormal=function(t){return this.cross(t).normalize(!0)},r.prototype.moveTo=function(t){for(var i=Point.get(arguments),e=this.$subtract(i),n=this.toArray(),s=0,o=n.length;s<o;s++)n[s].subtract(e);return this},r.prototype.moveBy=function(t){for(var i=Point.get(arguments),e=this.toArray(),n=0,s=e.length;n<s;n++)e[n].add(i);return this},r.prototype.rotate2D=function(t,i,e){var n,s,o,r,h;for(null==e&&(e=Const.xy),i=i||new Point(0,0,0),o=Matrix.rotateAnchor2D(t,i,e),n=0,s=(h=this.toArray()).length;n<s;n++)r=h[n],Matrix.transform2D(r,o,e);return this},r.prototype.reflect2D=function(t,i){var e,n,s,o,r;for(null==i&&(i=Const.xy),s=Matrix.reflectAnchor2D(t,i),e=0,n=(r=this.toArray()).length;e<n;e++)o=r[e],Matrix.transform2D(o,s,i);return this},r.prototype.scale2D=function(t,i,e,n){var s,o,r,h,u;for(null==n&&(n=Const.xy),e=e||new Point(0,0,0),r=Matrix.scaleAnchor2D(t,i,e,n),s=0,o=(u=this.toArray()).length;s<o;s++)h=u[s],Matrix.transform2D(h,r,n);return this},r.prototype.shear2D=function(t,i,e,n){var s,o,r,h,u;for(null==n&&(n=Const.xy),e=e||new Point(0,0,0),r=Matrix.shearAnchor2D(t,i,e,n),s=0,o=(u=this.toArray()).length;s<o;s++)h=u[s],Matrix.transform2D(h,r,n);return this},r.prototype.clone=function(){return new r(this)},r.prototype.toString=function(){return"Vector "+this.x+", "+this.y+", "+this.z},r}(),this.Vector=Vector,Color=function(){function u(t){u.__super__.constructor.apply(this,arguments),this.alpha=4<=arguments.length?Math.min(1,Math.max(arguments[3],0)):1,this.mode=5<=arguments.length?arguments[4]:"rgb"}return extend(u,Vector),u.XYZ={D65:{x:95.047,y:100,z:108.883}},u.parseHex=function(t,i){var e,n;return null==i&&(i=!1),0===t.indexOf("#")&&(t=t.substr(1)),3===t.length&&(t=""+t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),8===t.length&&(this.alpha=1&t.substr(6),t=t.substring(0,6)),n=[(e=parseInt(t,16))>>16,e>>8&255,255&e],i?new u(n[0],n[1],n[2]):n},u.prototype.setMode=function(t){if((t=t.toLowerCase())!==this.mode){switch(this.mode){case"hsl":this.copy(Point.get(u.HSLtoRGB(this.x,this.y,this.z)));break;case"hsb":this.copy(Point.get(u.HSBtoRGB(this.x,this.y,this.z)));break;case"lab":this.copy(Point.get(u.LABtoRGB(this.x,this.y,this.z)));break;case"lch":this.copy(Point.get(u.LCHtoRGB(this.x,this.y,this.z)));break;case"xyz":this.copy(Point.get(u.XYZtoRGB(this.x,this.y,this.z)))}switch(t){case"hsl":this.copy(Point.get(u.RGBtoHSL(this.x,this.y,this.z)));break;case"hsb":this.copy(Point.get(u.RGBtoHSB(this.x,this.y,this.z)));break;case"lab":this.copy(Point.get(u.RGBtoLAB(this.x,this.y,this.z)));break;case"lch":this.copy(Point.get(u.RGBtoLCH(this.x,this.y,this.z)));break;case"xyz":this.copy(Point.get(u.RGBtoXYZ(this.x,this.y,this.z)))}}return this.mode=t,this},u.prototype.hex=function(){var n,s,t,o;return"rgb"===this.mode&&this.floor(),s=this.values("rgb"!==this.mode),n=function(t){return(t=t.toString(16)).length<2?"0"+t:t},"#"+(t=function(){for(var t=[],i=0,e=s.length;i<e;i++)o=s[i],t.push(n(o));return t}())[0]+t[1]+t[2]},u.prototype.rgb=function(){var t;return"rgb"===this.mode&&this.floor(),"rgb("+(t=this.values("rgb"!==this.mode))[0]+", "+t[1]+", "+t[2]+")"},u.prototype.rgba=function(){var t;return"rgb"===this.mode&&this.floor(),"rgba("+(t=this.values("rgb"!==this.mode))[0]+", "+t[1]+", "+t[2]+", "+this.alpha+")"},u.prototype.values=function(t){var n,s;if(null==t&&(t=!1),n=[this.x,this.y,this.z],t&&"rgb"!==this.mode)switch(this.mode){case"hsl":n=u.HSLtoRGB(this.x,this.y,this.z);break;case"hsb":n=u.HSBtoRGB(this.x,this.y,this.z);break;case"lab":n=u.LABtoRGB(this.x,this.y,this.z);break;case"lch":n=u.LCHtoRGB(this.x,this.y,this.z);break;case"xyz":n=u.XYZtoRGB(this.x,this.y,this.z)}return function(){for(var t=[],i=0,e=n.length;i<e;i++)s=n[i],t.push(Math.floor(s));return t}()},u.prototype.clone=function(){var t=new u(this.x,this.y,this.z,this.alpha);return t.mode=this.mode,t},u.RGBtoHSL=function(t,i,e,n,s){var o,r,h,u,c,a;if(n||(t/=255,i/=255,e/=255),h=a=r=((u=Math.max(t,i,e))+(c=Math.min(t,i,e)))/2,u===c)a=r=0;else switch(o=u-c,a=.5<h?o/(2-u-c):o/(u+c),u){case t:r=(i-e)/o+(i<e?6:0);break;case i:r=(e-t)/o+2;break;case e:r=(t-i)/o+4;break;default:r=0}return s?[r/60,a,h]:[60*r,a,h]},u.HSLtoRGB=function(t,i,e,n,s){var o,r,h,u,c,a;return 0===i?s?[1,1,1]:[255,255,255]:(n||(t/=360),a=(h=function(t,i,e){return e<0?e+=1:1<e&&--e,6*e<1?t+(i-t)*e*6:2*e<1?i:3*e<2?t+(i-t)*(2/3-e)*6:t})(u=2*e-(c=e<=.5?e*(1+i):e+i-e*i),c,t+1/3),r=h(u,c,t),o=h(u,c,t-1/3),s?[a,r,o]:[255*a,255*r,255*o])},u.RGBtoHSB=function(t,i,e,n,s){var o,r,h,u,c,a;if(n||(t/=255,i/=255,e/=255),o=(h=Math.max(t,i,e))-(u=Math.min(t,i,e)),c=0===h?0:o/h,(a=h)===u)r=0;else switch(h){case t:r=(i-e)/o+(i<e?6:0);break;case i:r=(e-t)/o+2;break;case e:r=(t-i)/o+4;break;default:r=0}return s?[r/60,c,a]:[60*r,c,a]},u.HSBtoRGB=function(t,i,e,n,s){var o,r,h,u,c,a;switch(n||(t/=360),h=e*(1-i),u=e*(1-(o=6*t-(r=Math.floor(6*t)))*i),a=e*(1-(1-o)*i),r%6){case 0:c=[e,a,h];break;case 1:c=[u,e,h];break;case 2:c=[h,e,a];break;case 3:c=[h,u,e];break;case 4:c=[a,h,e];break;case 5:c=[e,h,u];break;default:c=[0,0,0]}return s?c:[255*c[0],255*c[1],255*c[2]]},u.RGBtoLAB=function(t,i,e,n,s){var o;return n&&(t*=255,i*=255,e*=255),o=u.RGBtoXYZ(t,i,e),u.XYZtoLAB(o[0],o[1],o[2])},u.LABtoRGB=function(t,i,e,n,s){var o,r;return n&&(t*=100,i=127*(i-.5),e=127*(e-.5)),r=u.LABtoXYZ(t,i,e),o=u.XYZtoRGB(r[0],r[1],r[2]),s?[o[0]/255,o[1]/255,o[2]/255]:o},u.RGBtoLCH=function(t,i,e,n,s){var o,r;return n&&(t*=255,i*=255,e*=255),o=u.RGBtoLAB(t,i,e),r=u.LABtoLCH(o[0],o[1],o[2]),s?[r[0]/100,r[1]/100,r[2]/360]:r},u.LCHtoRGB=function(t,i,e,n,s){var o,r,h;return n&&(t*=100,i*=100,e*=360),o=u.LCHtoLAB(t,i,e),h=u.LABtoXYZ(o[0],o[1],o[2]),r=u.XYZtoRGB(h[0],h[1],h[2]),s?[r[0]/255,r[1]/255,r[2]/255]:r},u.XYZtoRGB=function(t,i,e,n,s){var o,r,h,u,c;for(n||(t/=100,i/=100,e/=100),h=o=0,u=(c=[3.2404542*t+-1.5371385*i+-.4985314*e,-.969266*t+1.8760108*i+.041556*e,.0556434*t+-.2040259*i+1.0572252*e]).length;o<u;h=++o)r=c[h],c[h]=r<0?0:Math.min(1,.0031308<r?1.055*Math.pow(r,1/2.4)-.055:12.92*r);return s?c:[Math.round(255*c[0]),Math.round(255*c[1]),Math.round(255*c[2])]},u.RGBtoXYZ=function(t,i,e,n,s){return n||(t/=255,i/=255,e/=255),t=.04045<t?Math.pow((t+.055)/1.055,2.4):t/12.92,i=.04045<i?Math.pow((i+.055)/1.055,2.4):i/12.92,e=.04045<e?Math.pow((e+.055)/1.055,2.4):e/12.92,s||(t*=100,i*=100,e*=100),[.4124564*t+.3575761*i+.1804375*e,.2126729*t+.7151522*i+.072175*e,.0193339*t+.119192*i+.9503041*e]},u.XYZtoLAB=function(t,i,e){var n,s;return t/=u.XYZ.D65.x,i/=u.XYZ.D65.y,e/=u.XYZ.D65.z,[116*(s=(n=function(t){return.008856<t?Math.pow(t,1/3):7.787*t+16/116})(i))-16,500*(n(t)-s),200*(s-n(e))]},u.LABtoXYZ=function(t,i,e){var n=(t+16)/116,s=i/500+n,o=n-e/200,r=function(t){var i=Math.pow(t,3);return.008856<i?i:(t-16/116)/7.787};return[Math.min(u.XYZ.D65.x,u.XYZ.D65.x*r(s)),Math.min(u.XYZ.D65.y,u.XYZ.D65.y*r(n)),Math.min(u.XYZ.D65.y,u.XYZ.D65.z*r(o))]},u.XYZtoLUV=function(t,i,e){var n,s=4*t/(t+15*i+3*e),o=9*i/(t+15*i+3*e);return[n=116*(i=.008856<(i/=100)?Math.pow(i,1/3):7.787*i+16/116)-16,13*n*(s-4*u.XYZ.D65.x/(u.XYZ.D65.x+15*u.XYZ.D65.y+3*u.XYZ.D65.z)),13*n*(o-9*u.XYZ.D65.y/(u.XYZ.D65.x+15*u.XYZ.D65.y+3*u.XYZ.D65.z))]},u.LUVtoXYZ=function(t,i,e){var n,s=(t+16)/116,o=s*s*s;return s=.008856<o?o:(s-16/116)/7.787,[n=-9*(s*=100)*(i=i/(13*t)+4*u.XYZ.D65.x/(u.XYZ.D65.x+15*u.XYZ.D65.y+3*u.XYZ.D65.z))/((i-4)*(e=e/(13*t)+9*u.XYZ.D65.y/(u.XYZ.D65.x+15*u.XYZ.D65.y+3*u.XYZ.D65.z))-i*e),s,(9*s-15*e*s-e*n)/(3*e)]},u.LABtoLCH=function(t,i,e){var n=Math.atan2(e,i);return n=0<n?180*n/Math.PI:360-180*Math.abs(n)/Math.PI,[t,Math.sqrt(i*i+e*e),n]},u.LCHtoLAB=function(t,i,e){var n=Math.PI*e/180;return[t,Math.cos(n)*i,Math.sin(n)*i]},u.LUVtoLCH=function(t,i,e){return LABtoLCH(t,i,e)},u.LCHtoLUV=function(t,i,e){return LCHtoLAB(t,i,e)},u}(),this.Color=Color,Circle=function(){function s(){s.__super__.constructor.apply(this,arguments),this.radius=null!=arguments[3]?arguments[3]:0}return extend(s,Vector),s.prototype.setRadius=function(t){return this.radius=t,this},s.prototype.intersectPoint=function(t){var i=new Vector(Point.get(arguments)).$subtract(this);return i.x*i.x+i.y*i.y<this.radius*this.radius},s.prototype.intersectPath=function(t,i){var e,n,s,o,r,h,u,c,a,p;return null==i&&(i=!0),!(!t instanceof Pair)&&(n=t.direction(),r=this.$subtract(t),e=n.dot(n,Const.xy),(s=(h=r.dot(n,Const.xy)/e)*h-(r.dot(r,Const.xy)-this.radius*this.radius)/e)<0?!!i&&[]:!i||(a=-h+(o=Math.sqrt(s)),p=-h-o,u=new Point(t.x-n.x*a,t.y-n.y*a),c=new Point(t.x-n.x*p,t.y-n.y*p),0==s?[u]:[u,c]))},s.prototype.intersectLine=function(t,i){var e,n,s,o,r,h;if(null==i&&(i=!0),(h=this.intersectPath(t))&&0<h.length){for(r=[],n=t.bounds(),e=0,s=h.length;e<s;e++)if(o=h[e],Rectangle.contain(o,n,n.p1)){if(!i)return!0;r.push(o)}return i?r:0<r.length}return!!i&&[]},s.prototype.intersectLines=function(t,i){return null==i&&(i=!0),Line.intersectLines(this,t,i)},s.prototype.intersectCircle=function(t,i){var e,n,s,o,r,h,u,c;return null==i&&(i=!0),r=(h=t.$subtract(this)).magnitude(!1),o=Math.sqrt(r),n=this.radius*this.radius,s=t.radius*t.radius,o>this.radius+t.radius?!!i&&[]:o<Math.abs(this.radius-t.radius)?!i||[new Vector(this),new Vector(t)]:!i||(e=(n-s+r)/(2*o),u=Math.sqrt(n-e*e),c=h.$multiply(e/o).add(this),[new Vector(c.x+u*h.y/o,c.y-u*h.x/o),new Vector(c.x-u*h.y/o,c.y+u*h.x/o)])},s.prototype.hasIntersect=function(t,i){var e,n;return null==i&&(i=!1),t instanceof s?this.intersectCircle(t,i):t instanceof Rectangle||t instanceof PointSet||t instanceof Triangle?this.intersectLines(t.sides(),i):t instanceof Pair?(n=this.intersectLine(t),i?n:0<n.length):t instanceof Point?(e=t.$subtract(this)).x*e.x+e.y*e.y<this.radius*this.radius:!!i&&[]},s.prototype.toString=function(){return"Circle of "+this.radius+" radius at center "+this.x+", "+this.y+", "+this.z},s}(),this.Circle=Circle,Particle=function(){function i(){i.__super__.constructor.apply(this,arguments),this.id=0,this.life={age:0,maxAge:0,active:!0,complete:!1},this.momentum=new Vector,this.velocity=new Vector,this.mass=2,this.friction=0,this.frame_ms=20}return extend(i,Circle),i.prototype.play=function(t,i){for(var e,n=0,s=[];0<i;)e=Math.min(i,this.frame_ms),this.integrate(n/1e3,e/1e3),i-=e,n+=e,s.push(this.life.age++);return s},i.prototype.integrate=function(t,i){return this.integrateRK4(t,i)},i.prototype.forces=function(t,i){return{force:new Vector}},i.prototype.impulse=function(t){return this.momentum.add(t),this.velocity=this.momentum.$divide(this.mass)},i.prototype._evaluate=function(t,i,e){var n,s;return null==i&&(i=0),null==e&&(e=!1),(s=0!==i&&e?{position:this.$add(e.velocity.$multiply(i)),momentum:this.momentum.$add(e.force.$multiply(i))}:{position:new Vector(this),momentum:new Vector(this.momentum)}).velocity=s.momentum.$divide(this.mass),n=this.forces(s,t+i),{velocity:s.velocity,force:n.force}},i.prototype.integrateRK4=function(t,i){var e=function(t,i,e,n){return new Vector((t.x+2*(i.x+e.x)+n.x)/6,(t.y+2*(i.y+e.y)+n.y)/6,(t.z+2*(i.z+e.z)+n.z)/6)},n=this._evaluate(t,0),s=this._evaluate(t,.5*i,n),o=this._evaluate(t,.5*i,s),r=this._evaluate(t,i,o);return this.add(e(n.velocity,s.velocity,o.velocity,r.velocity)),this.momentum.add(e(n.force,s.force,o.force,r.force))},i.prototype.integrateEuler=function(t,i){var e=this.forces({position:new Vector(this),momentum:new Vector(this.momentum)},t+i);return this.add(this.velocity),this.momentum.add(e.force),this.velocity=this.momentum.$divide(this.mass)},i.prototype.collideLine2d=function(t,i){var e,n,s,o,r,h,u,c,a,p,l,y,f,d,m,x,g,v,z;if(null==i&&(i=!0),r=new Vector(this),o=Math.abs(t.getDistanceFromPoint(r)),n=Math.abs(o)<this.radius,i&&(a=this.$add(this.velocity),c=Math.abs(t.getDistanceFromPoint(a)),(s=t.intersectLine(new Line(r).to(a)))&&(a=s.$add(this.velocity.$normalize().$multiply(-this.radius/2)),c=Math.abs(t.getDistanceFromPoint(a)),n=!0)),n){if(m=t.getPerpendicularFromPoint(r),z=t.$subtract(t.p1),e=!1,!t.withinBounds(m,Const.xy)){if(this.intersectPoint(t)&&(e=!0,u=this.$subtract(t)),this.intersectPoint(t.p1)&&(e=!0,u=this.$subtract(t.p1)),!e)return!1;z=new Vector(-u.y,u.x)}h=z.dot(this.velocity),v=(f=z.$multiply(h/z.dot(z))).$subtract(this.velocity),this.velocity=f.$add(v),this.momentum=this.velocity.$multiply(this.mass),i&&!e&&(l=new Line(m).to(r),y=t.getPerpendicularFromPoint(a),x=(p=new Line(m).to(y)).direction(),g=(this.radius-o)/(c-o),d=x.$multiply(g).$add(p).$add(l.direction().$normalize().$multiply(this.radius)),this.set(d.$add(this.velocity.$normalize())))}return n},i.prototype.collideWithinBounds=function(t){return this.x-this.radius<t.x||this.x+this.radius>t.p1.x?(this.x-this.radius<t.x?this.x=t.x+this.radius:this.x+this.radius>t.p1.x&&(this.x=t.p1.x-this.radius),this.velocity.x*=-1,this.momentum=this.velocity.$multiply(this.mass),!0):(this.y-this.radius<t.y||this.y+this.radius>t.p1.y)&&(this.y-this.radius<t.y?this.y=t.y+this.radius:this.y+this.radius>t.p1.y&&(this.y=t.p1.y-this.radius),this.velocity.y*=-1,this.momentum=this.velocity.$multiply(this.mass),!0)},i.prototype.collideParticle2d=function(t){return!!this.hasIntersect(t)&&i.collideParticle2d(this,t,!0)},i.collideParticle2d=function(t,i,e,n){var s,o,r,h,u,c,a,p,l,y,f,d,m,x,g,v,z;return null==e&&(e=!0),null==n&&(n=!0),y=t.$subtract(i).normalize(),m=new Vector(-y.y,y.x),h=y.dot(t.velocity),u=m.dot(t.velocity),c=y.dot(i.velocity),a=m.dot(i.velocity),s=(h*(t.mass-i.mass)+2*i.mass*c)/(t.mass+i.mass),o=(c*(i.mass-t.mass)+2*t.mass*h)/(t.mass+i.mass),x=y.$multiply(s),g=m.$multiply(u),v=y.$multiply(o),z=m.$multiply(a),f=x.$add(g),d=v.$add(z),n&&((p=t.magnitude(i))<t.radius+i.radius&&(r=t.$subtract(i).normalize(),l=Math.abs(p-t.radius-i.radius)/1.98,t.add(r.multiply(l)),i.add(r.multiply(-l)))),e&&(t.velocity=f,i.velocity=d,t.momentum=t.velocity.$multiply(t.mass),i.momentum=i.velocity.$multiply(i.mass)),[f,d]},i.force_gravitation=function(t,i,e,n,s){var o,r,h;return null==s&&(s=.0067),r=0==(h=(o=n.$subtract(t.position)).magnitude()/30)?0:i*s*e.mass*n.mass/(h*h),o.normalize().multiply(r),{force:o}},i.RK4=function(t,i,e,n,s){var o=t,r=i,h=t+.5*r*n,u=i+.5*e(o,r,0,s)*n,c=t+.5*u*n,a=i+.5*e(h,u,n/2,s)*n;return{c:t+(o+2*(h+c)+(t+a*n))/6*n,d:i+(r+2*(u+a)+(i+e(c,a,n/2,s)*n))/6*n}},i}(),this.Particle=Particle,ParticleSystem=function(){function t(){this.count=0,this.particles=[],this.time=0}return t.prototype.add=function(t){return t.id=this.count++,this.particles.push(t),this},t.prototype.remove=function(t){return t&&t.life&&(t.life.complete=!0),this},t.prototype.animate=function(t,i,e){var n,s,o,r,h,u,c,a,p,l;for(this.time++,n=[],r=s=0,u=(p=this.particles).length;s<u;r=++s)(a=p[r]).life.complete?n.push(r):a.life.active&&a.animate(t,i,e);if(0<n.length){for(l=[],o=0,c=n.length;o<c;o++)h=n[o],l.push(this.particles.splice(h,1));return l}},t}(),this.ParticleSystem=ParticleSystem,Pair=function(){function i(){i.__super__.constructor.apply(this,arguments),this.p1=new Vector(this.x,this.y,this.z),4===arguments.length?(this.z=0,this.p1.set(arguments[2],arguments[3])):6===arguments.length&&this.p1.set(arguments[3],arguments[4],arguments[5])}return extend(i,Vector),i.prototype.to=function(){return this.p1=new Vector(Point.get(arguments)),this},i.prototype.getAt=function(t){return 1===t||"p1"===t?this.p1:this},i.prototype.$getAt=function(t){return new Vector(this.getAt(t))},i.prototype.relative=function(){return this.p1.add(this),this},i.prototype.$relative=function(){return this.$add(this.p1)},i.prototype.bounds=function(){return new i(this.$min(this.p1)).to(this.$max(this.p1))},i.prototype.withinBounds=function(t,i){var e,n;return i?(e=this.get2D(i),n=this.p1.get2D(i),e.x===n.x?t.y>=Math.min(e.y,n.y)&&t.y<=Math.max(e.y,n.y):e.y===n.y?t.x>=Math.min(e.x,n.x)&&t.x<=Math.max(e.x,n.x):t.x>=Math.min(e.x,n.x)&&t.y>=Math.min(e.y,n.y)&&t.x<=Math.max(e.x,n.x)&&t.y<=Math.max(e.y,n.y)):t.x>=Math.min(this.x,this.p1.x)&&t.y>=Math.min(this.y,this.p1.y)&&t.z>=Math.min(this.z,this.p1.z)&&t.x<=Math.max(this.x,this.p1.x)&&t.y<=Math.max(this.y,this.p1.y)&&t.z<=Math.max(this.z,this.p1.z)},i.prototype.interpolate=function(t,i){var e;return null==i&&(i=!1),e=i?this.$relative():this.p1,new Vector((1-t)*this.x+t*e.x,(1-t)*this.y+t*e.y,(1-t)*this.z+t*e.z)},i.prototype.midpoint=function(){return this.interpolate(.5)},i.prototype.direction=function(t){return t?this.$subtract(this.p1):this.p1.$subtract(this)},i.prototype.size=function(){return 0<arguments.length?(this.p1=this.$add(Point.get(arguments)),this):this.p1.$subtract(this).abs()},i.prototype.length=function(t){var i,e,n,s;return null==t&&(t=!0),s=this.z-this.p1.z,n=this.y-this.p1.y,i=(e=this.x-this.p1.x)*e+n*n+s*s,t?Math.sqrt(i):i},i.prototype.collinear=function(t){return(this.p1.x-this.x)*(t.y-this.y)-(t.x-this.x)*(this.p1.y-this.y)},i.prototype.resetBounds=function(){var t=this.$min(this.p1);return this.p1.set(this.$max(this.p1)),this.set(t),this},i.prototype.equal=function(t){return null==t&&(t=!1),t instanceof i?i.__super__.equal.call(this,t)&&this.p1.equal(t.p1):i.__super__.equal.apply(this,arguments)},i.prototype.clone=function(){var t=new i(this);return t.to(this.p1.clone()),t},i.prototype.floor=function(){return i.__super__.floor.apply(this,arguments),this.p1.floor()},i.prototype.toString=function(){return"Pair of vectors from ("+this.x+", "+this.y+", "+this.z+") to ("+this.p1.x+", "+this.p1.y+", "+this.p1.z+")"},i.prototype.toArray=function(){return[this,this.p1]},i}(),this.Pair=Pair,Line=function(){function h(){h.__super__.constructor.apply(this,arguments)}return extend(h,Pair),h.slope=function(t,i,e){var n,s;return null==e&&(e=Const.xy),n=t.get2D(e),(s=i.get2D(e)).x-n.x!=0&&(s.y-n.y)/(s.x-n.x)},h.intercept=function(t,i,e){var n,s,o,r;return null==e&&(e=Const.xy),o=t.get2D(e),(r=i.get2D(e)).x-o.x!=0&&{slope:s=(r.y-o.y)/(r.x-o.x),yi:n=o.y-s*o.x,xi:0!=s&&-n/s}},h.isPerpendicularLine=function(t,i,e){var n,s;return null==e&&(e=Const.xy),n=h.slope(t,t.p1,e),s=h.slope(i,i.p1,e),!1===n?0===s:!1===s?0===n:n*s==-1},h.prototype.slope=function(t){return null==t&&(t=Const.xy),h.slope(this,this.p1,t)},h.prototype.intercept=function(t){return null==t&&(t=Const.xy),h.intercept(this,this.p1,t)},h.prototype.getPerpendicular=function(t,i,e,n){var s,o,r;return null==i&&(i=10),null==e&&(e=!1),null==n&&(n=Const.xy),o=this.direction().normalize().perpendicular(n),r=e?o[1]:o[0],(s=new h(this.interpolate(t))).to(r.multiply(i).add(s)),s},h.prototype.getDistanceFromPoint=function(t){var i=this.$subtract(this.p1),e=new Vector(-i.y,i.x).normalize();return this.$subtract(t).dot(e)},h.prototype.getPerpendicularFromPoint=function(t,i){var e;return null==i&&(i=!0),e=this.p1.$subtract(this).projection(t.$subtract(this)),i?e.add(this):e},h.prototype.intersectPath=function(t,i){var e,n,s,o,r,h,u;return null==i&&(i=Const.xy),e=this.intercept(i),n=t.intercept(i),o=this.get2D(i),s=t.get2D(i),!1===e?!1!==n&&(u=-n.slope*(s.x-o.x)+s.y,i===Const.xy?new Vector(o.x,u):new Vector(o.x,u).get2D(i,!0)):!1===n?(u=-e.slope*(o.x-s.x)+o.y,new Vector(s.x,u)):n.slope!==e.slope?(r=(e.slope*o.x-n.slope*s.x+s.y-o.y)/(e.slope-n.slope),h=e.slope*(r-o.x)+o.y,i===Const.xy?new Vector(r,h):new Vector(r,h).get2D(i,!0)):e.yi===n.yi&&null},h.prototype.intersectLine=function(t,i){var e;return null==i&&(i=Const.xy),(e=this.intersectPath(t,i))&&this.withinBounds(e,i)&&t.withinBounds(e,i)?e:null===e&&null},h.intersectLines=function(t,i,e){var n,s,o,r,h,u,c;if(null==e&&(e=!0),!t.intersectLine)throw"No intersectLine function found in "+t.toString();for(s in c=[],i)if(h=i[s],o=t.intersectLine(h,e)){if(!e)return!0;if(0<o.length)for(n=0,r=o.length;n<r;n++)u=o[n],c.push(u)}return!!e&&c},h.prototype.intersectGridLine=function(t,i,e){var n,s,o,r;if(null==i&&(i=!1),null==e&&(e=Const.xy),n=this.get2D(e),s=this.p1.get2D(e),o=t.get2D(e),r=t.p1.get2D(e),s.x-n.x==0){if(r.y-o.y==0&&Util.within(n.x,o.x,r.x)&&(i||Util.within(o.y,n.y,s.y)))return new Vector(n.x,o.y)}else{if(s.y-n.y!=0)return!1;if(r.x-o.x==0&&Util.within(n.y,o.y,r.y)&&(i||Util.within(o.x,n.x,s.x)))return new Vector(o.x,n.y)}},h.prototype.subpoints=function(t){for(var i,e=[],n=i=0,s=t;0<=s?i<=s:s<=i;n=0<=s?++i:--i)e.push(this.interpolate(n/t));return e},h.prototype.clone=function(t){return new h(this).to(this.p1)},h}(),this.Line=Line,Rectangle=function(){function e(){e.__super__.constructor.apply(this,arguments),this.center=new Vector}return extend(e,Pair),e.contain=function(t,i,e){return t.x>=i.x&&t.x<=e.x&&t.y>=i.y&&t.y<=e.y&&t.z>=i.z&&t.z<=e.z},e.prototype.toString=function(){var t=this.size();return"Rectangle x1 "+this.x+", y1 "+this.y+", z1 "+this.z+", x2 "+this.p1.x+", y2 "+this.p1.y+", z2 "+this.p1.z+", width "+t.x+", height "+t.y},e.prototype.toPointSet=function(){var t=this.corners();return new PointSet(this).to([t.topRight,t.bottomRight,t.bottomLeft,t.topLeft])},e.prototype.to=function(t){return this.p1=new Vector(Point.get(arguments)),this.resetBounds(),this.center=this.midpoint(),this},e.prototype.setCenter=function(t){var i;return 0===arguments.length?void(this.center=this.midpoint()):(i=this.size().$divide(2),this.center.set(Point.get(arguments)),this.set(this.center.$subtract(i)),this.p1.set(this.center.$add(i)),this)},e.prototype.resizeTo=function(){return this.p1=new Vector(Point.get(arguments)),this.relative(),this.center=this.midpoint(),this},e.prototype.resizeCenterTo=function(){var t=new Vector(Point.get(arguments)).divide(2);return this.set(this.center.$subtract(t)),this.p1.set(this.center.$add(t)),this},e.prototype.enclose=function(t){return this.set(this.$min(t)),this.p1.set(this.p1.$max(t.p1)),this.center=this.midpoint(),this},e.prototype.$enclose=function(t){return this.clone().enclose(t)},e.prototype.isEnclosed=function(t){var i=this.$subtract(t).multiply(this.p1.$subtract(t.p1)),e=this.size().subtract(t.size());return i.x<=0&&i.y<=0&&i.z<=0&&0<=e.x*e.y},e.prototype.isLarger=function(t){var i=this.size(),e=t.size();return i.x*i.y>e.x*e.y},e.prototype.intersectPoint=function(){var t=Point.get(arguments);return t.x>=this.x&&t.x<=this.p1.x&&t.y>=this.y&&t.y<=this.p1.y&&t.z>=this.z&&t.z<=this.p1.z},e.prototype.intersectPath=function(t,i){var e,n,s,o,r;for(null==i&&(i=!0),o=[],e=0,n=(r=this.sides()).length;e<n;e++)if((s=r[e].intersectPath(t))&&this.intersectPoint(s)){if(!i)return!0;o.push(s)}return!!i&&o},e.prototype.intersectLine=function(t,i){var e,n,s,o,r,h,u,c,a;if(null==i&&(i=!0),n=this.intersectPoint(t),s=this.intersectPoint(t.p1),n&&s&&i)return[];if(!n&&!s&&(o=t.bounds(),!this.intersectRectangle(o,!1)))return!!i&&[];for(u=[],e=0,r=(a=this.sides()).length;e<r;e++)if(c=a[e],h=t.intersectLine(c)){if(!i)return!0;u.push(h)}return!!i&&u},e.prototype.intersectLines=function(t,i){return null==i&&(i=!0),Line.intersectLines(this,t,i)},e.prototype.intersectRectangle=function(t,i){var e,n,s,o,r,h,u,c,a,p,l,y,f,d;if(null==i&&(i=!0),y=this.p1.x>=t.x&&this.x<=t.p1.x,f=this.p1.y>=t.y&&this.y<=t.p1.y,d=this.p1.z>=t.z&&this.z<=t.p1.z,s=y&&f&&d,!i)return s;if(this.isEnclosed(t))return!i||[];if(!s)return[];for(p=this.sides(),l=t.sides(),u=[],e=0,o=p.length;e<o;e++)for(c=p[e],n=0,r=l.length;n<r;n++)a=l[n],(h=c.intersectGridLine(a))&&u.push(h);return u},e.prototype.hasIntersect=function(t,i){return null==i&&(i=!1),t instanceof Circle?t.intersectLines(this.sides(),i):t instanceof e?this.intersectRectangle(t,i):t instanceof PointSet||t instanceof Triangle?this.intersectLines(t.sides(),i):t instanceof Pair?this.intersectLine(t,i):t instanceof Point?e.contain(t,this,this.p1):!!i&&[]},e.prototype.corners=function(){return{topLeft:new Vector(Math.min(this.x,this.p1.x),Math.min(this.y,this.p1.y),Math.max(this.z,this.p1.z)),topRight:new Vector(Math.max(this.x,this.p1.x),Math.min(this.y,this.p1.y),Math.min(this.z,this.p1.z)),bottomLeft:new Vector(Math.min(this.x,this.p1.x),Math.max(this.y,this.p1.y),Math.max(this.z,this.p1.z)),bottomRight:new Vector(Math.max(this.x,this.p1.x),Math.max(this.y,this.p1.y),Math.min(this.z,this.p1.z))}},e.prototype.sides=function(){var t=this.corners();return[new Line(t.topLeft).to(t.topRight),new Line(t.topRight).to(t.bottomRight),new Line(t.bottomRight).to(t.bottomLeft),new Line(t.bottomLeft).to(t.topLeft)]},e.prototype.quadrants=function(){var t=this.corners();return{topLeft:new this.__proto__.constructor(t.topLeft).to(this.center),topRight:new this.__proto__.constructor(t.topRight).to(this.center),bottomLeft:new this.__proto__.constructor(t.bottomLeft).to(this.center),bottomRight:new this.__proto__.constructor(t.bottomRight).to(this.center)}},e.prototype.clone=function(){var t=new e(this).to(this.p1);return t.to(this.p1.clone()),t},e}(),this.Rectangle=Rectangle,Grid=function(){function t(){t.__super__.constructor.apply(this,arguments),this.cell={type:"fix-fix",size:new Vector},this.rows=0,this.columns=0,this.layout=[],this.cellCallback=null}return extend(t,Rectangle),t.prototype.toString=function(){var t=this.size();return"Grid width "+t.x+", height "+t.y+", columns "+this.columns+", rows "+this.rows+", cell ("+this.cell.size.x+", "+this.cell.size.y+"), type "+this.cell.type},t.prototype.init=function(t,i,e,n){var s;return null==e&&(e="fix"),null==n&&(n="fix"),s=this.size(),this.cell.type=e+"-"+n,this.rows=i,this.columns=t,"stretch"===e?(this.cell.size.x=s.x/t,this.columns=t):"flex"===e?(this.columns=Math.round(s.x/t),this.cell.size.x=s.x/this.columns):(this.cell.size.x=t,this.columns=Math.floor(s.x/this.cell.size.x)),"stretch"===n?(this.cell.size.y=s.y/i,this.rows=i):"flex"===n?(this.rows=Math.round(s.y/i),this.cell.size.y=s.y/this.rows):(this.cell.size.y=i,this.rows=Math.floor(s.y/this.cell.size.y)),this},t.prototype.generate=function(t){return"function"==typeof t&&(this.cellCallback=t),this},t.prototype.create=function(){var t,i,e,n,s,o,r,h,u;if(!this.cellCallback)return this;for(e=t=0,h=this.columns;0<=h?t<h:h<t;e=0<=h?++t:--t)for(r=i=0,u=this.rows;0<=u?i<u:u<i;r=0<=u?++i:--i)n=this.cell.size.clone(),o=this.$add(n.$multiply(e,r)),s=0<this.layout.length&&0<this.layout[0].length&&1===this.layout[r][e],this.cellCallback(n,o,r,e,this.cell.type,s);return this},t.prototype.getCellSize=function(){return this.cell.size.clone()},t.prototype.cellToRectangle=function(t,i,e){return null==e&&(e=!1),!!(e||0<=t&&t<this.columns&&0<=i&&i<this.rows)&&new Rectangle(this.$add(this.cell.size.$multiply(t,i))).resizeTo(this.cell.size)},t.prototype.positionToCell=function(t){var i=new Vector(this._getArgs(arguments)).$subtract(this).$divide(this.cell.size).floor();return i.max(0,0).min(this.columns-1,this.rows-1),i},t.prototype.resetLayout=function(t){var i,e,n,s,o,r;for(this.layout=[],s=i=0,o=this.rows;0<=o?i<o:o<i;s=0<=o?++i:--i)for(this.layout[s]=[],n=e=0,r=this.columns;0<=r?e<r:r<e;n=0<=r?++e:--e)this.layout[s][n]=0,t&&t(this,s,n);return this},t.prototype.occupy=function(t,i,e,n,s){var o,r,h,u,c,a;if(null==s&&(s=!0),this.rows<=0||this.columns<=0)return this;for(this.layout.length<1&&this.resetLayout(),h=o=0,c=e;0<=c?o<c:c<o;h=0<=c?++o:--o)for(u=r=0,a=n;0<=a?r<a:a<r;u=0<=a?++r:--r)this.layout[Math.min(this.layout.length-1,i+u)][t+h]=s?1:0;return this},t.prototype.canFit=function(t,i,e,n){for(var s,o,r,h,u,c,a,p=s=u=i,l=Math.min(this.rows,i+n);u<=l?s<l:l<s;p=u<=l?++s:--s)for(h=o=c=t,a=Math.min(this.columns,t+e);c<=a?o<a:a<o;h=c<=a?++o:--o)if(null!=(r=this.layout[p][h])&&0<r)return!1;return!0},t.prototype.fit=function(t,i){for(var e,n,s,o,r,h,u,c,a=Math.min(t,this.columns),p=e=0,l=this.rows;0<=l?e<l:l<e;p=0<=l?++e:--e)for(r=a,h=n=u=0,c=this.columns;0<=c?n<c:c<n;h=0<=c?++n:--n)if(null!=(o=this.layout[p][h])&&0<o)u++,r=a;else if(--r<=0)return this.occupy(u,p,a,i),(s=new Rectangle(this.$add(this.cell.size.$multiply(u,p)))).resizeTo(this.cell.size.$multiply(a,i)),{row:p,column:u,columnSize:a,rowSize:i,bound:s};return!1},t.prototype.neighbors=function(t,i){for(var e,n=[[t-1,i-1],[t,i-1],[t+1,i-1],[t+1,i],[t+1,i+1],[t,i+1],[t-1,i+1],[t-1,i]],s=[],o=0,r=n.length;o<r;o++)e=n[o],s.push(0<=e[0]&&e[0]<this.columns&&0<=e[1]&&e[1]<this.rows&&new Vector(e[0],e[1],this.layout[e[1]][e[0]]));return s},t}(),this.Grid=Grid,PointSet=function(){function t(){t.__super__.constructor.apply(this,arguments),this.points=[]}return extend(t,Vector),t.prototype.toString=function(){for(var t,i="PointSet [ ",e=this.points,n=0,s=e.length;n<s;n++)i+=(t=e[n]).x+","+t.y+","+t.z+", ";return i+" ]"},t.prototype.toArray=function(){return this.points.slice()},t.prototype.to=function(t){var i,e,n,s;if(0<arguments.length)if(Array.isArray(t)&&0<t.length&&"object"==typeof t[0])for(i=0,e=(s=t).length;i<e;i++)n=s[i],this.points.push(new Vector(n));else this.points.push(new Vector(Point.get(arguments)));return this},t.prototype.getAt=function(t){return this.points[Math.min(this.points.length-1,Math.max(0,t))]},t.prototype.$getAt=function(t){return new Vector(this.getAt(t))},t.prototype.setAt=function(t,i){return this.points[t]=i,this},t.prototype.count=function(){return this.points.length},t.prototype.connectFromAnchor=function(t){var i,e,n,s;if(0<arguments.length)if(Array.isArray(t)&&0<t.length)for(i=0,e=(s=t).length;i<e;i++)n=s[i],this.points.push(this.$add(n));else this.points.push(this.$add(Point.get(arguments)));return this},t.prototype.disconnect=function(t){return null==t&&(t=-1),this.points=t<0?this.points.slice(0,this.points.length+t):this.points.slice(t+1),this},t.prototype.clear=function(){return this.points=[],this},t.prototype.sides=function(t){var i,e,n,s,o,r;for(null==t&&(t=!0),e=null,r=[],i=0,n=(o=this.points).length;i<n;i++)s=o[i],e&&r.push(new Line(e).to(s)),e=s;return 1<this.points.length&&t&&r.push(new Line(e).to(this.points[0])),r},t.prototype.angles=function(t){var i,e,n,s,o,r;for(null==t&&(t=Const.xy),e=[],n=i=1,s=this.points.length-1;i<s;n=i+=1)o=this.points[n-1].$subtract(this.points[n]),r=this.points[n+1].$subtract(this.points[n]),e.push({p0:this.points[n-1],p1:this.points[n],p2:this.points[n+1],angle:o.angleBetween(r)});return e},t.prototype.bounds=function(){return Util.boundingBox(this.points)},t.prototype.centroid=function(){return Util.centroid(this.points)},t.prototype.convexHull=function(t){var i,e,n,s,o;if(null==t&&(t=!0),this.points.length<3)return[];for(t?(o=this.points.slice()).sort(function(t,i){return t.x-i.x}):o=this.points,i=[],(n=function(t,i,e){return 0<(i.x-t.x)*(e.y-t.y)-(e.x-t.x)*(i.y-t.y)})(o[0],o[1],o[2])?(i.push(o[0]),i.push(o[1])):(i.push(o[1]),i.push(o[0])),i.unshift(o[2]),i.push(o[2]),e=3;e<o.length;)if(n(s=o[e],i[0],i[1])&&n(i[i.length-2],i[i.length-1],s))e++;else{for(;!n(i[i.length-2],i[i.length-1],s);)i.pop();for(i.push(s);!n(i[0],i[1],s);)i.shift();i.unshift(s),e++}return i},t.prototype.clone=function(){return new t(this).to(Util.clonePoints(this.points))},t}(),this.PointSet=PointSet,Curve=function(){function t(){t.__super__.constructor.apply(this,arguments),this.is3D=!1}return extend(t,PointSet),t.prototype._getSteps=function(t){for(var i,e,n=[],s=i=0,o=t;i<=o;s=i+=1)e=s/t,n.push([e,e*e,e*e*e]);return n},t.prototype.controlPoints=function(t,i){var e,n,s;return null==t&&(t=0),null==i&&(i=!1),e=function(t){return t<s.points.length-1?t:s.points.length-1},null!=(n=(s=this).points[t]).x&&(t=i?t:t+1,{p0:n,p1:this.points[e(t++)],p2:this.points[e(t++)],p3:this.points[e(t++)]})},t.prototype.catmullRom=function(t){var i,e,n,s,o,r,h,u,c;if(null==t&&(t=10),this.points.length<2)return[];for(r=[],c=this._getSteps(t),n=this.controlPoints(0,!0),s=i=0,h=t;i<=h;s=i+=1)r.push(this.catmullRomPoint(c[s],n));for(o=0;o<this.points.length-2;)if(n=this.controlPoints(o)){for(s=e=0,u=t;e<=u;s=e+=1)r.push(this.catmullRomPoint(c[s],n));o++}return r},t.prototype.catmullRomPoint=function(t,i){var e=t[0],n=t[1],s=t[2],o=-.5*s+n-.5*e,r=1.5*s-2.5*n+1,h=-1.5*s+2*n+.5*e,u=.5*s-.5*n,c=o*i.p0.x+r*i.p1.x+h*i.p2.x+u*i.p3.x,a=o*i.p0.y+r*i.p1.y+h*i.p2.y+u*i.p3.y,p=this.is3D?o*i.p0.z+r*i.p1.z+h*i.p2.z+u*i.p3.z:0;return new Point(c,a,p)},t.prototype.cardinal=function(t,i){var e,n,s,o,r,h,u,c,a;if(null==t&&(t=10),null==i&&(i=.5),this.points.length<2)return[];for(h=[],a=this._getSteps(t),s=this.controlPoints(0,!0),o=e=0,u=t;e<=u;o=e+=1)h.push(this.cardinalPoint(a[o],s,i));for(r=0;r<this.points.length-2;)if(s=this.controlPoints(r)){for(o=n=0,c=t;n<=c;o=n+=1)h.push(this.cardinalPoint(a[o],s,i));r++}return h},t.prototype.cardinalPoint=function(t,i,e){var n,s,o,r,h,u,c,a,p,l,y,f;return null==e&&(e=.5),c=t[0],a=t[1],n=e*(-1*(p=t[2])+2*a-c),s=e*(-1*p+a),o=2*p-3*a+1,r=e*(p-2*a+c),h=-2*p+3*a,u=e*(p-a),l=i.p0.x*n+i.p1.x*s+o*i.p1.x+i.p2.x*r+h*i.p2.x+i.p3.x*u,y=i.p0.y*n+i.p1.y*s+o*i.p1.y+i.p2.y*r+h*i.p2.y+i.p3.y*u,f=this.is3D?i.p0.z*n+i.p1.z*s+o*i.p1.z+i.p2.z*r+h*i.p2.z+i.p3.z*u:0,new Point(l,y,f)},t.prototype.bezier=function(t){var i,e,n,s,o,r,h;if(null==t&&(t=10),this.points.length<4)return[];for(o=[],h=this._getSteps(t),s=0;s<=this.points.length-3;)if(e=this.controlPoints(s)){for(n=i=0,r=t;i<=r;n=i+=1)o.push(this.bezierPoint(h[n],e));s+=3}return o},t.prototype.bezierPoint=function(t,i){var e=t[0],n=t[1],s=t[2],o=-1*s+3*n-3*e+1,r=3*s-6*n+3*e,h=-3*s+3*n,u=o*i.p0.x+r*i.p1.x+h*i.p2.x+s*i.p3.x,c=o*i.p0.y+r*i.p1.y+h*i.p2.y+s*i.p3.y,a=this.is3D?o*i.p0.z+r*i.p1.z+h*i.p2.z+s*i.p3.z:0;return new Point(u,c,a)},t.prototype.bspline=function(t,i){var e,n,s,o,r,h,u,c,a;if(null==t&&(t=10),null==i&&(i=!1),this.points.length<2)return[];for(h=[],a=this._getSteps(t),r=0;r<this.points.length-2;)if(s=this.controlPoints(r)){if(i)for(o=n=0,c=t;n<=c;o=n+=1)h.push(this.bsplineTensionPoint(a[o],s,i));else for(o=e=0,u=t;e<=u;o=e+=1)h.push(this.bsplinePoint(a[o],s));r++}return h},t.prototype.bsplinePoint=function(t,i){var e=t[0],n=t[1],s=t[2],o=-.16666666666*s+.5*n-.5*e+.16666666666,r=.5*s-n+.66666666666,h=-.5*s+.5*n+.5*e+.16666666666,u=.16666666666*s,c=o*i.p0.x+r*i.p1.x+h*i.p2.x+u*i.p3.x,a=o*i.p0.y+r*i.p1.y+h*i.p2.y+u*i.p3.y,p=this.is3D?o*i.p0.z+r*i.p1.z+h*i.p2.z+u*i.p3.z:0;return new Point(c,a,p)},t.prototype.bsplineTensionPoint=function(t,i,e){var n,s,o,r,h,u,c,a,p,l,y,f;return null==e&&(e=1),c=t[0],a=t[1],s=e*(-1.5*(p=t[2])+2*a-.33333333333),o=2*p-3*a+1,r=e*(1.5*p-2.5*a+.5*c+.16666666666),h=-2*p+3*a,u=.16666666666*e*p,l=(n=e*(-.16666666666*p+.5*a-.5*c+.16666666666))*i.p0.x+s*i.p1.x+o*i.p1.x+r*i.p2.x+h*i.p2.x+u*i.p3.x,y=n*i.p0.y+s*i.p1.y+o*i.p1.y+r*i.p2.y+h*i.p2.y+u*i.p3.y,f=this.is3D?n*i.p0.z+s*i.p1.z+o*i.p1.y+r*i.p2.z+h*i.p2.z+u*i.p3.z:0,new Point(l,y,f)},t}(),this.Curve=Curve,Triangle=function(){function i(){i.__super__.constructor.apply(this,arguments),this.p1=new Vector(this.x-1,this.y-1,this.z),this.p2=new Vector(this.x+1,this.y+1,this.z)}return extend(i,Vector),i.prototype.to=function(t){return 0<arguments.length&&("object"==typeof t&&2===arguments.length?(this.p1.set(t),this.p2.set(arguments[1])):arguments.length<6?(this.p1.set([t,arguments[1]]),this.p2.set([arguments[2],arguments[3]])):(this.p1.set([t,arguments[1],arguments[2]]),this.p2.set([arguments[3],arguments[4],arguments[5]]))),this},i.prototype.toArray=function(){return[this,this.p1,this.p2]},i.prototype.toString=function(){return"Triangle ("+this.x+", "+this.y+", "+this.z+"), ("+this.p1.x+", "+this.p1.y+", "+this.p1.z+"), ("+this.p2.x+", "+this.p2.y+", "+this.p2.z+")"},i.prototype.getAt=function(t){return 1===t||"p1"===t?this.p1:2===t||"p2"===t?this.p2:this},i.prototype.$getAt=function(t){return new Vector(this.getAt(t))},i.prototype.toPointSet=function(){var t=new Vector(this);return new PointSet(t).to([t,this.p1,this.p2])},i.prototype.sides=function(){return[new Line(this).to(this.p1),new Line(this.p1).to(this.p2),new Line(this.p2).to(this)]},i.prototype.angles=function(t){var i;return null==t&&(t=Const.xy),(i=[this.p2.$subtract(this).angleBetween(this.p1.$subtract(this),t),this.$subtract(this.p1).angleBetween(this.p2.$subtract(this.p1),t)]).push(Math.PI-i[0]-i[1]),i},i.prototype.medial=function(){var n,s=this.sides(),t=function(){for(var t=[],i=0,e=s.length;i<e;i++)n=s[i],t.push(n.midpoint());return t}();return new i(t[0]).to(t[1],t[2])},i.prototype.perimeter=function(){var t=this.sides(),i=[t[0].length(),t[1].length(),t[2].length()];return{sides:t,value:i[0]+i[1]+i[2],lengths:i}},i.prototype.area=function(){var t=this.perimeter(),i=t.value/2;return{value:Math.sqrt(i*(i-t.lengths[0])*(i-t.lengths[1])*(i-t.lengths[2])),perimeter:t}},i.prototype.oppositeSide=function(t){return"p1"===t?new Line(this).to(this.p2):"p2"===t?new Line(this).to(this.p1):new Line(this.p1).to(this.p2)},i.prototype.adjacentSides=function(t){return"p1"===t?[new Line(this.p1).to(this),new Line(this.p1).to(this.p2)]:"p2"===t?[new Line(this.p2).to(this),new Line(this.p2).to(this.p1)]:[new Line(this).to(this.p1),new Line(this).to(this.p2)]},i.prototype.bisector=function(t,i,e){var n,s,o;return null==i&&(i=!1),null==e&&(e=100),n=this.adjacentSides(t),o=new Vector(n[0]),n[0].moveTo(0,0),n[1].moveTo(0,0),s=n[0].p1.bisect(n[1].p1),i?new Line(o).to(s.multiply(e).add(o)):s},i.prototype.altitude=function(t){return"p1"===t||"p2"===t?new Line(this[t]).to(this.oppositeSide(t).getPerpendicularFromPoint(this[t])):new Line(this).to(this.oppositeSide().getPerpendicularFromPoint(this))},i.prototype.centroid=function(){var t=this.$divide(3),i=this.p1.$divide(3),e=this.p2.$divide(3);return new Vector(t.x+i.x+e.x,t.y+i.y+e.y,t.z+i.z+e.z)},i.prototype.orthocenter=function(){var t=this.altitude(),i=this.altitude("p1");return t.intersectPath(i,Const.xyz)},i.prototype.incenter=function(){var t=this.bisector("p0",!0),i=this.bisector("p1",!0);return t.intersectPath(i,Const.xyz)},i.prototype.incircle=function(){var t=this.incenter(),i=this.area(),e=2*i.value/i.perimeter.value;return new Circle(t).setRadius(e)},i.prototype.circumcenter=function(){var t=this.medial(),i=[new Line(t).to(this.$subtract(t).perpendicular()[0].$add(t)),new Line(t.p1).to(this.p1.$subtract(t.p1).perpendicular()[0].$add(t.p1)),new Line(t.p2).to(this.p2.$subtract(t.p2).perpendicular()[0].$add(t.p2))];return{center:i[0].intersectPath(i[1],Const.xyz),bisectors:i}},i.prototype.circumcircle=function(){var t=this.circumcenter(),i=this.magnitude(t.center);return new Circle(t.center).setRadius(i)},i.prototype.intersectPoint=function(n){var s,o=this.sides(),t=function(){for(var t=[],i=0,e=o.length;i<e;i++)s=o[i],t.push(0<s.collinear(n));return t}();return t[0]===t[1]&&t[1]===t[2]},i.prototype.intersectPath=function(t,i,e){var n,s,o,r,h,u;for(null==i&&(i=!0),null==e&&(e=Const.xy),r=[],n=0,s=(u=this.sides()).length;n<s;n++)if((o=(h=u[n]).intersectPath(t))&&h.withinBounds(o,e)){if(!i)return!0;r.push(o)}return!!i&&r},i.prototype.intersectLine=function(t,i,e){var n,s,o,r,h;for(null==i&&(i=!0),null==e&&(e=Const.xy),h=[],n=0,o=(s=this.intersectPath(t,!0,e)).length;n<o;n++)if(r=s[n],t.withinBounds(r)){if(!i)return!0;h.push(r)}return!!i&&h},i.prototype.intersectLines=function(t,i){return null==i&&(i=!0),Line.intersectLines(this,t,i)},i.prototype.intersectPath3D=function(t,i){var e,n,s,o,r,h,u=this.p1.$subtract(this),c=this.p2.$subtract(this),a=t.direction().normalize(),p=a.cross(c),l=u.dot(p);return!(l>-Const.epsilon&&l<Const.epsilon)&&(e=1/l,!((r=(o=t.$subtract(this)).dot(p)*e)<0||1<r)&&(n=o.cross(u),!((h=a.dot(n)*e)<0||1<h)&&((s=c.dot(n)*e)>Const.epsilon&&(!i||[r,h,s]))))},i.prototype.intersectRectangle=function(t,i){return null==i&&(i=!0),t.intersectLines(this.sides(),i)},i.prototype.intersectCircle=function(t,i){return null==i&&(i=!0),t.intersectLines(this.sides(),i)},i.prototype.intersectTriangle=function(t,i){return null==i&&(i=!0),t.intersectLines(this.sides(),i)},i.prototype.clone=function(){return new i(this).to(this.p1,this.p2)},i}(),this.Triangle=Triangle,SVGForm=function(){function p(t){this.cc=t.ctx||{},this.cc.group=this.cc.group||null,this.cc.groupID="ptx",this.cc.groupCount=0,this.cc.currentID="ptx0",this.cc.style={fill:"#999",stroke:"#666","stroke-width":1,"stroke-linejoin":!1,"stroke-linecap":!1},this.cc.font="11px sans-serif",this.cc.fontSize=11,this.cc.fontFace="sans-serif"}return p._domId=0,p.prototype.fill=function(t){return this.cc.style.fill=t||!1,this},p.prototype.stroke=function(t,i,e,n){return this.cc.style.stroke=t||!1,i&&(this.cc.style["stroke-width"]=i),e&&(this.cc.style["stroke-linejoin"]=e),n&&(this.cc.style["stroke-linecap"]=e),this},p.prototype.scope=function(t,i){return null==i&&(i=!1),i&&(this.cc.group=i),this.cc.groupID=t,this.cc.groupCount=0,this.nextID(),this.cc},p.prototype.getScope=function(t){if(!t||null===t.animateID)throw"getScope()'s item must be added to a Space, and has an animateID property. Otherwise, use scope() instead.";return this.scope(p._scopeID(t))},p.prototype.nextID=function(){return this.cc.groupCount++,this.cc.currentID=this.cc.groupID+"-"+this.cc.groupCount,this.cc.currentID},p.id=function(t){return t.currentID||"p-"+p._domId++},p._scopeID=function(t){return"item"+t.animateID},p.style=function(t,i){var e,n,s=[];for(e in i)(n=i[e])?s.push(e+":"+n):"fill"===e?s.push("fill: none"):"stroke"===e&&s.push("stroke: none");return DOMSpace.attr(t,{style:s.join(";")})},p.point=function(t,i,e,n,s,o){var r;return null==e&&(e=2),null==n&&(n=!0),null==s&&(s=!0),null==o&&(o=!1),(r=SVGSpace.svgElement(t.group,o?"circle":"rect",p.id(t)))?(o?DOMSpace.attr(r,{cx:i.x,cy:i.y,r:e}):DOMSpace.attr(r,{x:i.x-e,y:i.y-e,width:e+e,height:e+e}),p.style(r,t.style),r):void 0},p.prototype.point=function(t,i,e){return null==i&&(i=2),null==e&&(e=!1),this.nextID(),p.point(this.cc,t,i,!0,!0,e),this},p.points=function(n,s,o,r,h,u){var c;return null==o&&(o=2),null==r&&(r=!0),null==h&&(h=!0),null==u&&(u=!1),function(){for(var t=[],i=0,e=s.length;i<e;i++)c=s[i],t.push(p.point(n,c,o,r,h,u));return t}()},p.prototype.points=function(t,i,e){var n,s,o;for(null==i&&(i=2),null==e&&(e=!1),n=0,s=t.length;n<s;n++)o=t[n],this.point(o,i,e);return this},p.line=function(t,i){var e;if(!i.p1)throw i.toString()+" is not a Pair";return e=SVGSpace.svgElement(t.group,"line",p.id(t)),DOMSpace.attr(e,{x1:i.x,y1:i.y,x2:i.p1.x,y2:i.p1.y}),p.style(e,t.style),e},p.prototype.line=function(t){return this.nextID(),p.line(this.cc,t),this},p.lines=function(n,s){var o;return function(){for(var t=[],i=0,e=s.length;i<e;i++)o=s[i],t.push(p.line(n,o));return t}()},p.prototype.lines=function(t){for(var i,e=0,n=t.length;e<n;e++)i=t[e],this.line(i);return this},p.rect=function(t,i,e,n){var s,o;if(null==e&&(e=!0),null==n&&(n=!0),!i.p1)throw""+(i.toString()===!a(Pair));return s=SVGSpace.svgElement(t.group,"rect",p.id(t)),o=i.size(),DOMSpace.attr(s,{x:i.x,y:i.y,width:o.x,height:o.y}),p.style(s,t.style),s},p.prototype.rect=function(t,i){var e;return null==i&&(i=!0),this.nextID(),e=i?t.bounds():t,p.rect(this.cc,e),this},p.circle=function(t,i,e,n){var s;return null==e&&(e=!0),null==n&&(n=!1),(s=SVGSpace.svgElement(t.group,"circle",p.id(t)))?(DOMSpace.attr(s,{cx:i.x,cy:i.y,r:i.radius}),p.style(s,t.style),s):void 0},p.prototype.circle=function(t){return this.nextID(),p.circle(this.cc,t),this},p.polygon=function(t,n,i,e,s){var o,r,h;return null==i&&(i=!0),null==e&&(e=!0),null==s&&(s=!0),!(o=SVGSpace.svgElement(t.group,i?"polygon":"polyline",p.id(t)))||n.length<=1?void 0:(h=function(){var t,i,e=[];for(r=t=0,i=n.length;t<i;r=t+=1)e.push(n[r].x+","+n[r].y);return e}(),DOMSpace.attr(o,{points:h.join(" ")}),p.style(o,t.style),o)},p.prototype.polygon=function(t,i){return this.nextID(),p.polygon(this.cc,t,i),this},p.triangle=function(t,i,e,n){return null==e&&(e=!0),null==n&&(n=!1),p.polygon(t,i.toArray())},p.prototype.triangle=function(t){return this.nextID(),p.triangle(this.cc,t),this},p.curve=function(t,i,e){return null==e&&(e=!1),p.polygon(t,i,e)},p.prototype.curve=function(t,i){return null==i&&(i=!1),this.nextID(),p.curve(this.cc,t,i),this},p.text=function(t,i,e,n,s,o){var r;return null==n&&(n=0),null==s&&(s=0),null==o&&(o=0),(r=SVGSpace.svgElement(t.group,"text",p.id(t)))?(DOMSpace.attr(r,{"pointer-events":"none",x:i.x,y:i.y,dx:0,dy:0}),r.textContent=e,p.style(r,{fill:t.style.fill,stroke:t.style.stroke,"font-family":t.fontFace||!1,"font-size":t.fontSize||!1}),r):void 0},p.prototype.text=function(t,i,e,n,s){return null==e&&(e=1e3),this.nextID(),p.text(this.cc,t,i,e,n,s),this},p.prototype.font=function(t,i){return null==i&&(i=!1),this.cc.fontFace=i,this.cc.fontSize=t,this.cc.font=t+"px "+i,this},p.prototype.draw=function(t){return this.sketch(t)},p.prototype.sketch=function(t){return t.floor(),t instanceof Circle?p.circle(this.cc,t,this.filled,this.stroked):t instanceof Rectangle?p.rect(this.cc,t,this.filled,this.stroked):t instanceof Triangle?p.triangle(this.cc,t,this.filled,this.stroked):t instanceof Line||t instanceof Pair?p.line(this.cc,t):t instanceof PointSet?p.polygon(this.cc,t.points):(t instanceof Vector||t instanceof Point)&&p.point(this.cc,t),this},p}(),this.SVGForm=SVGForm,SVGSpace=function(){function n(t,i,e){null==t&&(t="pt_space"),null==i&&(i=!1),null==e&&(e="svg"),n.__super__.constructor.apply(this,arguments),this.bg=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.bg.setAttribute("id",t+"_bg"),this.bg.setAttribute("fill",i),this.space.appendChild(this.bg)}return extend(n,DOMSpace),n.prototype._createSpaceElement=function(){return this.space=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.space.setAttribute("id",this.id),this.appended=!1},n.svgElement=function(t,i,e){var n;if(!t||!t.appendChild)throw"parent parameter needs to be a DOM node";return(n=document.querySelector("#"+e))||((n=document.createElementNS("http://www.w3.org/2000/svg",i)).setAttribute("id",e),n.setAttribute("class",e.substring(0,e.indexOf("-"))),t.appendChild(n)),n},n.prototype.resize=function(t,i,e){var n,s,o;for(n in this.size.set(t,i),this.center=new Vector(t/2,i/2),this.space.setAttribute("width",t),this.space.setAttribute("height",i),this.bg.setAttribute("width",t),this.bg.setAttribute("height",i),o=this.items)null!=(s=o[n]).onSpaceResize&&s.onSpaceResize(t,i,e);return this},n.prototype.remove=function(t){for(var i,e=this.space.querySelectorAll("."+SVGForm._scopeID(t)),n=0,s=e.length;n<s;n++)(i=e[n]).parentNode.removeChild(i);return delete this.items[t.animateID],this},n.prototype.removeAll=function(){if(this.space.firstChild)return this.space.removeChild(this.space.firstChild),this},n}(),this.SVGSpace=SVGSpace,Easing=function(){function i(){}return i.linear=function(t,i,e,n){return e*(t/=n)+i},i._linear=function(t){return i.linear(t,0,1,1)},i.quadIn=function(t,i,e,n){return e*(t/=n)*t+i},i._quadIn=function(t){return i.quadIn(t,0,1,1)},i.quadOut=function(t,i,e,n){return-e*(t/=n)*(t-2)+i},i._quadOut=function(t){return i.quadOut(t,0,1,1)},i.cubicIn=function(t,i,e,n){return e*(t/=n)*t*t+i},i._cubicIn=function(t){return i.cubicIn(t,0,1,1)},i.cubicOut=function(t,i,e,n){return e*(((t/=n)-1)*t*t+1)+i},i._cubicOut=function(t){return i.cubicOut(t,0,1,1)},i.elastic=function(t,i,e,n,s){var o,r,h;return null==s&&(s=.3),h=1.70158,r=n*s,o=e,0===t?i:1===(t/=n)?i+e:(h=o<Math.abs(e)?(o=e,r/4):0!==o?r/Const.two_pi*Math.asin(e/o):0,o*Math.pow(2,-10*t)*Math.sin((t*n-h)*Const.two_pi/r)+e+i)},i._elastic=function(t){return i.elastic(t,0,1,1)},i.bounce=function(t,i,e,n){return(t/=n)<1/2.75?7.5625*e*t*t+i:t<2/2.75?e*(7.5625*(t-=1.5/2.75)*t+.75)+i:t<2.5/2.75?e*(7.5625*(t-=2.25/2.75)*t+.9375)+i:e*(7.5625*(t-=2.625/2.75)*t+.984375)+i},i._bounce=function(t){return i.bounce(t,0,1,1)},i}(),this.Easing=Easing,GridCascade=function(){function t(){t.__super__.constructor.apply(this,arguments),this.startRow=0}return extend(t,Grid),t.prototype.resetLayout=function(){return this.layout=[],this.startRow=0},t.prototype.occupy=function(t,i,e,n){for(var s,o,r,h,u,c,a=s=h=t,p=e+t;h<=p?s<p:p<s;a=h<=p?++s:--s)for(c=n+(r=o=u=i);u<=c?o<c:c<o;r=u<=c?++o:--o)null==this.layout[r]&&(this.layout[r]=[]),this.layout[r][a]=1;return this},t.prototype.findStartRow=function(){for(var t,i,e,n,s,o=this.startRow,r=t=n=this.startRow,h=this.rows;n<=h?t<h:h<t;r=n<=h?++t:--t)for(o=r,e=i=0,s=this.columns;0<=s?i<s:s<i;e=0<=s?++i:--i)if(null!=this.layout[r]&&(null==this.layout[r][e]||this.layout[r][e]<=0))return o;return o},t.prototype.fit=function(t,i){for(var e,n,s,o,r,h,u,c,a,p,l,y,f,d,m=Math.min(t,this.columns),x=e=l=this.startRow,g=this.rows;l<=g?e<g:g<e;x=l<=g?++e:--e)for(u=m,a=0,x+i>=this.rows&&(this.rows+=i),null==this.layout[x]&&(this.layout[x]=[]),c=n=0,y=this.columns;0<=y?n<y:y<n;c=0<=y?++n:--n)if(null!=(h=this.layout[x][c])&&0<h)a=c+1,u=m;else if(0===--u){if(o=!0,1<i)for(d=(p=s=f=x)+i;f<=d?s<d:d<s;p=f<=d?++s:--s)if(p<=this.rows&&null!=this.layout[p]&&0<this.layout[p][a]){o=!1;break}if(o)return this.occupy(a,x,m,i),x>this.startRow&&(this.startRow=this.findStartRow()),(r=new Rectangle(this.$add(this.cell.size.$multiply(a,x)))).resizeTo(this.cell.size.$multiply(m,i)),{row:x,column:a,columnSize:m,rowSize:i,bound:r}}return console.error("cannot fit "+x+" "+a+" "+t+" "+i),!1},t}(),this.GridCascade=GridCascade,ParticleEmitter=function(){function t(){t.__super__.constructor.apply(this,arguments),this.system=null,this.lastTime=0,this.period=0,this.animateID=-1}return extend(t,Vector),t.prototype.init=function(t){return this.system=t},t.prototype.frequency=function(t){return this.period=1e3/t,this},t.prototype.emit=function(){},t.prototype.animate=function(t,i,e){return t-this.lastTime>this.period?(this.emit(),this.lastTime=t):void 0},t}(),this.ParticleEmitter=ParticleEmitter,ParticleField=function(){function t(){t.__super__.constructor.apply(this,arguments),this.system=void 0}return extend(t,Rectangle),t.prototype.check=function(t,i){var e,n,s,o;for(null==i&&(i=!1),o=[],e=0,n=t.length;e<n;e++)s=t[e],this.hasIntersect(s)?this.work(s):o.push(s);return i?o:t},t.prototype.work=function(t){},t}(),this.ParticleField=ParticleField,QuadTree=function(){function t(){t.__super__.constructor.apply(this,arguments),this.quads=!1,this.items=[],this.depth=0,this.max_depth=6,this.max_items=2}return extend(t,Rectangle),t.prototype.getQuads=function(t,i){var e,n,s;if(null==i&&(i=[]),this.intersectPoint(t)&&(i.push(this),this.quads))for(e in s=this.quads)(n=s[e]).intersectPoint(t)&&n.getQuads(t,i);return i},t.prototype.getItems=function(t){var i,e,n;if(this.intersectPoint(t)){if(!this.quads)return this.items;if(this.quads)for(i in n=this.quads)if((e=n[i]).intersectPoint(t))return e.getItems(t)}return[]},t.prototype.addToQuad=function(t){var i,e,n;if(!t)return-1;if(this.quads){for(e in n=this.quads)if(0<(i=n[e].addToQuad(t)))return i;return-1}return!this.quads&&this.intersectPoint(t)?this.items.length>=this.max_items?this.depth<this.max_depth?(this.splitQuad(),this.addToQuad(t)):-1:(this.items.push(t),this.depth):-1},t.prototype.splitQuad=function(){var t,i,e,n,s,o,r,h,u,c,a,p;for(s in this.quads=this.quadrants(),h=this.quads)h[s].depth=this.depth+1;for(e=t=0,o=(u=this.items).length;t<o;e=++t)n=u[e],this.addToQuad(n)>this.depth&&(this.items[e]=null);for(a=[],i=0,r=(c=this.items).length;i<r;i++)p=c[i],a.push(p?void 0:this.items.splice(p,1));return a},t.prototype.resetQuad=function(){var t,i;if(this.items=[],this.quads){for(t in i=this.quads)i[t].resetQuad();return this.quads=!1}},t}(),this.QuadTree=QuadTree,SamplePoints=function(){function t(){t.__super__.constructor.apply(this,arguments),this.bestcandidate=null,this.poisson=null,this.bound=null,this.boundsize=null}return extend(t,PointSet),t.prototype.setBounds=function(t,i){return null==i&&(i=!1),i&&this.set(t),this.bound=new Rectangle(this).size(t.size()),this},t.prototype.bestCandidateSampler=function(){return this.points=[],this.bound||(this.bound=(new Rectangle).size(500,500)),this.boundsize=this.bound.size(),this.bestcandidate={halfsize:this.boundsize.$divide(2),quartersize:this.boundsize.$divide(4),maxDist:this.boundsize.x*this.boundsize.x+this.boundsize.y*this.boundsize.y},this},t.prototype.poissonSampler=function(t){var i;return this.points=[],this.bound||(this.bound=(new Rectangle).size(500,500)),this.boundsize=this.bound.size(),i=t*Math.SQRT1_2,this.poisson={grid:[],gridWidth:Math.ceil(this.boundsize.x/i),gridHeight:Math.ceil(this.boundsize.y/i),cellSize:i,radius:t,radius2:t*t,R:3*t*t,queue:[],queueSize:0,sampleSize:0,sincos:Util.sinCosTable()},this},t.prototype.sample=function(t,i){var e,n,s,o,r,h,u,c,a,p,l,y,f,d;if(null==t&&(t=10),null==i&&(i=!1),this.poisson&&"poisson"===i){if(0<this.poisson.sampleSize&&0===this.poisson.queueSize)return!1;if(!this.poisson.sampleSize)return this._poissonSample(this.bound.x+this.boundsize.x/2,this.bound.y+this.boundsize.y/2);for(;this.poisson.queueSize;){for(h=Math.floor(Math.random()*this.poisson.queueSize),y=this.poisson.queue[h],n=0,p=t;n<p;n+=1)if(e=Math.floor(360*Math.random()),a=Math.sqrt(Math.random()*this.poisson.R+this.poisson.radius2),f=y.x+a*this.poisson.sincos.cos[e],d=y.y+a*this.poisson.sincos.sin[e],f>=this.bound.x&&f<this.boundsize.x&&d>=this.bound.y&&d<this.boundsize.y&&this._poissonCheck(f,d))return this._poissonSample(f,d);this.poisson.queue[h]=this.poisson.queue[--this.poisson.queueSize],this.poisson.queue.length=this.poisson.queueSize}return!0}if(this.bestcandidate){for(o=null,r=-1,h=s=0,l=t;s<l;h=s+=1){if(c=new Vector(this.bound.x+this.boundsize.x*Math.random(),this.bound.y+this.boundsize.y*Math.random()),0===this.points.length){o=c;break}r<(u=this._bestCandidateCheck(c))&&(o=c,r=u)}return o&&this.points.push(o),o}},t.prototype._bestCandidateCheck=function(t){for(var i,e,n,s,o,r=this.bestcandidate.maxDist,h=new Rectangle(t.x-this.bestcandidate.quartersize.x,t.y-this.bestcandidate.quartersize.y).size(this.bestcandidate.halfsize.x,this.bestcandidate.halfsize.y),u=function(){for(var t=this.points,i=[],e=0,n=t.length;e<n;e++)s=t[e],h.intersectPoint(s)&&i.push(s);return i}.call(this),c=0,a=u.length;c<a;c++)(i=(e=(o=u[c]).x-t.x)*e+(n=o.y-t.y)*n)<r&&(r=i);return r},t.prototype._poissonSample=function(t,i){var e=new Point(t,i);return this.poisson.queue.push(e),this.poisson.grid[this.poisson.gridWidth*(i/this.poisson.cellSize|0)+(t/this.poisson.cellSize|0)]=e,this.poisson.sampleSize++,this.poisson.queueSize++,e},t.prototype._poissonCheck=function(t,i){var e,n,s,o,r,h,u,c,a=Math.floor(t/this.poisson.cellSize),p=Math.floor(i/this.poisson.cellSize),l=Math.max(a-2,0),y=Math.max(p-2,0),f=Math.min(a+3,this.poisson.gridWidth),d=Math.min(p+3,this.poisson.gridHeight);for(p=e=y,h=d;e<h;p=e+=1)for(r=p*this.poisson.gridWidth,a=n=l,u=f;n<u;a=n+=1)if((c=this.poisson.grid[r+a])&&(s=c.x-t)*s+(o=c.y-i)*o<this.poisson.radius2)return!1;return!0},t.bestCandidate=function(t,p,i){var e,n,s,o,l,y,r,h,f,u,c;for(null==i&&(i=10),c=t.size(),l=c.$divide(2),f=c.$divide(4),y=c.x*c.x+c.y*c.y,e=function(t){for(var i,e,n,s,o,r=y,h=new Rectangle(t.x-f.x,t.y-f.y).size(l.x,l.y),u=function(){for(var t=[],i=0,e=p.length;i<e;i++)s=p[i],h.intersetPoint(s)&&t.push(s);return t}(),c=0,a=u.length;c<a;c++)(i=(e=(o=u[c]).x-t.x)*e+(n=o.y-t.y)*n)<r&&(r=i);return r},s=null,o=-1,n=0,u=i;0<=u?n<u:u<n;0<=u?++n:--n){if(h=new Vector(t.x+c.x*Math.random(),t.y+c.y*Math.random()),0===p.length)return h;o<(r=e(h))&&(s=h,o=r)}return s},t}(),this.SamplePoints=SamplePoints,StripeBound=function(){function t(){t.__super__.constructor.apply(this,arguments),this.frequency=new Point,this.stripes=new Point,this.method="frequency",this.mask=null}return extend(t,Rectangle),t.prototype.setFrequency=function(t,i){return this.frequency=new Vector(t,i),this.method="frequency"},t.prototype.setStripes=function(t,i){return this.stripes=new Point(t,i),this.method="stripes"},t.prototype.getStripes=function(){for(var t,i,e,n,s,o,r=this.size(),h={columns:[],rows:[]},u="frequency"===this.method?this.frequency.clone():r.$divide(this.stripes).floor(),c=r.$divide(u),a=t=0,p=u.y-1;0<=p?t<=p:p<=t;a=0<=p?++t:--t)n=c.y*a,(s=new Pair(0,n).to(r.x,n+c.y).add(this)).p1.add(this),h.rows.push(s);for(a=i=0,o=u.x-1;0<=o?i<=o:o<=i;a=0<=o?++i:--i)e=c.x*a,(s=new Pair(e,0).to(e+c.x+.5,r.y).add(this)).p1.add(this),h.columns.push(s);return h},t.prototype.getStripeLines=function(){for(var t,i,e,n,s,o,r=this.size(),h={columns:[],rows:[]},u="frequency"===this.method?this.frequency.clone():r.$divide(this.stripes).floor(),c=r.$divide(u),a=t=0,p=u.y;0<=p?t<=p:p<=t;a=0<=p?++t:--t)n=c.y*a,(s=new Pair(0,n).to(r.x,n).add(this)).p1.add(this),h.rows.push(s);for(a=i=0,o=u.x;0<=o?i<=o:o<=i;a=0<=o?++i:--i)e=c.x*a,(s=new Pair(e,0).to(e,r.y).add(this)).p1.add(this),h.columns.push(s);return h},t.prototype.setMask=function(t,i,e){var n,s;return null==e&&(e=!1),this.mask=new Rectangle(this.x,this.y),s=this.size(),e=e?this.$add(e):(n=s.$subtract(t,i).divide(2),new Point(this.x+n.x,this.y+n.y)),this.mask.set(e.x,e.y).size(t,i)},t.prototype.anchorMask=function(){var t=this.$subtract(this.mask);return this.moveBy(t),this.mask.moveBy(t)},t}(),this.StripeBound=StripeBound,UI=function(){function s(){s.__super__.constructor.apply(this,arguments),this.dragging=!1}return extend(s,Rectangle),s.dragTarget=null,s.prototype.animate=function(t,i,e){return e.fillStyle="#f00",Form.rect(e,this)},s.prototype.onMouseAction=function(t,i,e,n){return this.intersectPoint(i,e)&&("drag"!==t||s.dragTarget||(this.dragging=!0,s.dragTarget=this)),this.dragging&&"move"===t&&this.moveTo(i,e).moveBy(this.size().multiply(-.5)),"drop"===t?(this.dragging=!1,s.dragTarget=null):void 0},s}(),this.UI=UI,Noise=function(){function t(){var e;t.__super__.constructor.apply(this,arguments),this.p=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,9,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this.perm=function(){var t,i=[];for(e=t=0;t<512;e=++t)i.push(this.p[255&e]);return i}.call(this)}return extend(t,Vector),t.prototype.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],t.prototype.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]],t.prototype.seed=function(t){var i,e,n,s;for(0<t&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8),n=[],e=i=0;i<=255;e=++i)s=1&e?this.p[e]^255&t:this.p[e]^t>>8&255,n.push(this.perm[e]=this.perm[e+256]=s);return n},t.prototype._dot=function(t,i,e){return t[0]*i+t[1]*e},t.prototype.perlin2d=function(t,i){var e,n,s,o,r,h,u,c,a,p;return null==t&&(t=this.x),null==i&&(i=this.y),e=function(t){return t*t*t*(t*(6*t-15)+10)},a=t-(n=Math.floor(t)%255),p=i-(s=Math.floor(i)%255),o=this._dot(this.grad3[(n+this.perm[s])%12],a,p),r=this._dot(this.grad3[(n+this.perm[1+s])%12],a,p-1),h=this._dot(this.grad3[(1+n+this.perm[s])%12],a-1,p),u=this._dot(this.grad3[(1+n+this.perm[1+s])%12],a-1,p-1),c=e(a),Util.lerp(Util.lerp(o,h,c),Util.lerp(r,u,c),e(p))},t.prototype.simplex2d=function(t,i){var e,n,s,o,r,h,u,c,a,p,l,y,f,d,m,x,g,v,z,_,b;return null==t&&(t=this.x),null==i&&(i=this.y),l=(t+i)*(.5*(Math.sqrt(3)-1)),r=Math.floor(t+l),a=(z=i-((c=Math.floor(i+l))-(y=(r+c)*(e=(3-Math.sqrt(3))/6))))<(x=t-(r-y))?(h=1,0):(h=0,1),g=x-h+e,_=z-a+e,v=x-1+2*e,b=z-1+2*e,u=255&r,p=255&c,n=this.perm[u+this.perm[p]]%12,s=this.perm[u+h+this.perm[p+a]]%12,o=this.perm[1+u+this.perm[1+p]]%12,70*(((f=.5-x*x-z*z)<0?0:(f*=f)*f*this._dot(this.grad3[n],x,z))+((d=.5-g*g-_*_)<0?0:(d*=d)*d*this._dot(this.grad3[s],g,_))+((m=.5-v*v-b*b)<0?0:(m*=m)*m*this._dot(this.grad3[o],v,b)))},t}(),Delaunay=function(){function t(){t.__super__.constructor.apply(this,arguments),this.mesh=[]}return extend(t,PointSet),t.prototype.generate=function(){var t,i,e,n,s,o,r,h,u,c,a,p,l,y,f,d,m,x,g,v,z;if(!(this.points.length<3)){for(a=[],c=t=0,g=f=this.points.length;t<g;c=t+=1)a[c]=c;for(a.sort((z=this,function(t,i){return z.points[i].x-z.points[t].x})),x=this.points.slice(),v=this._supertriangle(),x.push(new Vector(v),new Vector(v.p1),new Vector(v.p2)),m=[this._circum(f,f+1,f+2,v)],o=[],u=[],i=0,l=a.length;i<l;i++){for(n=a[i],u=[],p=m.length;p--;)s=m[p],r=x[n].x-s.circle.x,h=x[n].y-s.circle.y,0<r&&r*r>s.circle.radius*s.circle.radius?(o.push(s),m.splice(p,1)):r*r+h*h-s.circle.radius*s.circle.radius>Const.epsilon||(u.push(s.i,s.j,s.j,s.k,s.k,s.i),m.splice(p,1));for(this._dedupe(u),p=u.length;1<p;)m.push(this._circum(u[--p],u[--p],n,null,x))}for(e=0,y=m.length;e<y;e++)(d=m[e]).i<f&&d.j<f&&d.k<f&&o.push(d);return this.mesh=o,this.mesh}},t.prototype._supertriangle=function(){for(var t,i,e,n,s=new Vector,o=new Vector,r=this.points,h=0,u=r.length;h<u;h++)n=r[h],s.min(n),o.max(n);return t=o.$subtract(s),e=s.$add(o).divide(2),i=Math.max(t.x,t.y),new Triangle(e.$subtract(20*i,i)).to(e.$add(0,20*i),e.$add(20*i,-i))},t.prototype._triangle=function(t,i,e,n){return null==n&&(n=this.points),new Triangle(n[t]).to(n[i],n[e])},t.prototype._circum=function(t,i,e,n,s){return null==n&&(n=null),null==s&&(s=this.points),{i:t,j:i,k:e,triangle:n=n||this._triangle(t,i,e,s),circle:n.circumcircle()}},t.prototype._dedupe=function(t){for(var i,e,n,s,o,r=t.length;1<r;)for(e=t[--r],i=t[--r],n=r;1<n;)if(o=t[--n],i===(s=t[--n])&&e===o||i===o&&e===s){t.splice(r,2),t.splice(n,2);break}return t},t}(),this.Delaunay=Delaunay;